<!DOCTYPE html>
<html>
 <head>
  <title>E-MailRelay Reference</title>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <link rel="stylesheet" href="emailrelay.css" type="text/css">
 </head>
 <body>
  <!-- index:0::::E-MailRelay Reference -->
 <div class="div-main">
  <h1><a class="a-header" name="H_1">E-MailRelay Reference</a></h1> <!-- index:1:H:E-MailRelay Reference -->
   <h2><a class="a-header" name="SH_1_1">Command line usage</a></h2> <!-- index:2:SH:1:1:Command line usage -->
    <p>
     The <em>emailrelay</em> program supports the following command-line usage:
    </p>

      <div class="div-pre">
       <pre>emailrelay [&lt;option&gt; [&lt;option&gt; ...]] [&lt;config-file&gt;]
</pre>
      </div><!-- div-pre -->
    <p>
     where &lt;option&gt; is:
    </p>

    <dl>
     <dt>--address-verifier &lt;program&gt;</dt>
      <dd>
       Runs the specified external program to verify a message recipent's e-mail
       address. A network verifier can be specified as <em>net:<transport-address></em>.
      </dd>
     <dt>--admin &lt;admin-port&gt; (-a)</dt>
      <dd>
       Enables an administration interface on the specified listening port number.
       Use telnet or something similar to connect. The administration interface
       can be used to trigger forwarding of spooled mail messages if the
       <em>--forward-to</em> option is used.
      </dd>
     <dt>--admin-terminate (-Q)</dt>
      <dd>
       Enables the <em>terminate</em> command in the administration interface.
      </dd>
     <dt>--anonymous (-A)</dt>
      <dd>
       Disables the server's SMTP VRFY command, sends less verbose SMTP responses
       and SMTP greeting, and stops <em>Received</em> lines being added to mail message
       content files.
      </dd>
     <dt>--as-client &lt;host:port&gt; (-q)</dt>
      <dd>
       This is equivalent to <em>--log</em>, <em>--no-syslog</em>, <em>--no-daemon</em>, <em>--dont-serve</em>,
       <em>--forward</em> and <em>--forward-to</em>. It is a convenient way of running a
       forwarding agent that forwards spooled mail messages and then terminates.
      </dd>
     <dt>--as-proxy &lt;host:port&gt; (-y)</dt>
      <dd>
       This is equivalent to <em>--log</em>, <em>--close-stderr</em>, <em>--forward-on-disconnect</em>
       and <em>--forward-to</em>. It is a convenient way of running a store-and-forward
       daemon. Use <em>--log</em>, <em>--forward-on-disconnect</em> and <em>--forward-to</em> instead
       of <em>--as-proxy</em> to keep the standard error stream open.
      </dd>
     <dt>--as-server (-d)</dt>
      <dd>
       This is equivalent to <em>--log</em> and <em>--close-stderr</em>. It is a convenient way of
       running a background storage daemon that accepts mail messages and spools
       them. Use <em>--log</em> instead of <em>--as-server</em> to keep standard error stream
       open.
      </dd>
     <dt>--client-auth &lt;file&gt; (-C)</dt>
      <dd>
       Enables SMTP client authentication with the remote server, using the client
       account details taken from the specified secrets file. The secrets file
       should normally contain one line that starts with <em>client</em> and that line
       should have between four and five space-separated fields; the second field
       is the password encoding (<em>plain</em> or <em>md5</em>), the third is the user-id and
       the fourth is the password. The user-id is RFC-1891 xtext encoded, and the
       password is either xtext encoded or generated by <em>emailrelay-passwd</em>. If
       the remote server does not support SMTP authentication then the SMTP
       connection will fail.
      </dd>
     <dt>--client-auth-config &lt;config&gt;</dt>
      <dd>
       Configures the SMTP client authentication module using a semicolon-separated
       list of configuration items. Each item is a single-character key, followed
       by a colon and then a comma-separated list. A 'm' character introduces an
       ordered list of authentication mechanisms, and an 'x' is used for
       blocklisted mechanisms.
      </dd>
     <dt>--client-filter &lt;program&gt; (-Y)</dt>
      <dd>
       Runs the specified external filter program whenever a mail message is
       forwarded. The filter is passed the name of the message file in the spool
       directory so that it can edit it as required. A network filter can be
       specified as <em>net:<transport-address></em> and prefixes of <em>spam:</em>,
       <em>spam-edit:</em> and <em>exit:</em> are also allowed. The <em>spam:</em> and <em>spam-edit:</em>
       prefixes require a SpamAssassin daemon to be running. For store-and-forward
       applications the <em>--filter</em> option is normally more useful than
       <em>--client-filter</em>.
      </dd>
     <dt>--client-interface &lt;ip-address&gt; (-6)</dt>
      <dd>
       Specifies the IP network address to be used to bind the local end of outgoing
       SMTP connections. By default the address will depend on the routing tables
       in the normal way. Use <em>0.0.0.0</em> to use only IPv4 addresses returned from
       DNS lookups of the <em>--forward-to</em> address, or <em>::</em> for IPv6.
      </dd>
     <dt>--client-tls (-j)</dt>
      <dd>
       Enables negotiated TLS for outgoing SMTP connections; the SMTP STARTTLS
       command will be issued if the remote server supports it.
      </dd>
     <dt>--client-tls-certificate &lt;pem-file&gt;</dt>
      <dd>
       Defines the TLS certificate file when acting as a SMTP client. This file must
       contain the client's private key and certificate chain using the PEM file
       format. Keep the file permissions tight to avoid accidental exposure of the
       private key.
      </dd>
     <dt>--client-tls-connection (-b)</dt>
      <dd>
       Enables the use of a TLS tunnel for outgoing SMTP connections. This is for
       SMTP over TLS (SMTPS), not TLS negotiated within SMTP using STARTTLS.
      </dd>
     <dt>--client-tls-required</dt>
      <dd>
       Makes the use of TLS mandatory for outgoing SMTP connections. The SMTP
       STARTTLS command will be used before mail messages are sent out. If the
       remote server does not allow STARTTLS then the SMTP connection will fail.
      </dd>
     <dt>--client-tls-server-name &lt;hostname&gt;</dt>
      <dd>
       Defines the target server hostname in the TLS handshake. With
       <em>--client-tls-connection</em> this can be used for SNI, allowing the remote
       server to adopt an appropriate identity.
      </dd>
     <dt>--client-tls-verify &lt;ca-list&gt;</dt>
      <dd>
       Enables verification of the remote SMTP server's certificate against any of
       the trusted CA certificates in the specified file or directory. In many use
       cases this should be a file containing just your self-signed root
       certificate.
      </dd>
     <dt>--client-tls-verify-name &lt;cname&gt;</dt>
      <dd>
       Enables verification of the CNAME within the remote SMTP server's
       certificate.
      </dd>
     <dt>--close-stderr (-e)</dt>
      <dd>
       Causes the standard error stream to be closed soon after start-up. This is
       useful when operating as a backgroud daemon and it is therefore implied by
       <em>--as-server</em> and <em>--as-proxy</em>.
      </dd>
     <dt>--connection-timeout &lt;time&gt; (-U)</dt>
      <dd>
       Specifies a timeout (in seconds) for establishing a TCP connection to remote
       SMTP servers. The default is 40 seconds.
      </dd>
     <dt>--debug (-g)</dt>
      <dd>
       Enables debug level logging, if built in. Debug messages are usually only
       useful when cross-referenced with the source code and they may expose
       plaintext passwords and mail message content.
      </dd>
     <dt>--dnsbl &lt;config&gt;</dt>
      <dd>
       Specifies a list of DNSBL servers that are used to reject SMTP connections
       from blocked addresses. The configuration string is made up of
       comma-separated fields: the DNS server's transport address, a timeout in
       milliseconds, a rejection threshold, and then the list of DNSBL servers.
      </dd>
     <dt>--domain &lt;fqdn&gt; (-D)</dt>
      <dd>
       Specifies the network name that is used in SMTP EHLO commands, <em>Received</em>
       lines, and for generating authentication challenges. The default is derived
       from a DNS lookup of the local hostname.
      </dd>
     <dt>--dont-serve (-x)</dt>
      <dd>
       Disables all network serving, including SMTP, POP and administration
       interfaces. The program will terminate as soon as any initial forwarding is
       complete.
      </dd>
     <dt>--filter &lt;program&gt; (-z)</dt>
      <dd>
       Runs the specified external filter program whenever a mail message is stored.
       The filter is passed the name of the message file in the spool directory so
       that it can edit it as required. The mail message is rejected if the filter
       program terminates with an exit code between 1 and 99. Use
       <em>net:<transport-address></em> to communicate with a filter daemon over the
       network, or <em>spam:<transport-address></em> for a spamassassin spamd daemon to
       accept or reject mail messages, or <em>spam-edit:<transport-address></em> to have
       spamassassin edit the message content without rejecting it, or
       <em>exit:<number></em> to emulate a filter program that just exits.
      </dd>
     <dt>--filter-timeout &lt;time&gt; (-W)</dt>
      <dd>
       Specifies a timeout (in seconds) for running a <em>--filter</em> program. The
       default is 300 seconds.
      </dd>
     <dt>--forward (-f)</dt>
      <dd>
       Causes spooled mail messages to be forwarded when the program first starts.
      </dd>
     <dt>--forward-on-disconnect (-1)</dt>
      <dd>
       Causes spooled mail messages to be forwarded whenever a SMTP client
       connection disconnects.
      </dd>
     <dt>--forward-to &lt;host:port&gt; (-o)</dt>
      <dd>
       Specifies the transport address of the remote SMTP server that is use for
       mail message forwarding.
      </dd>
     <dt>--forward-to-some</dt>
      <dd>
       Allow forwarding to continue even if some recipient addresses on an e-mail
       envelope are rejected by the remote server.
      </dd>
     <dt>--help (-h)</dt>
      <dd>
       Displays help text and then exits. Use with <em>--verbose</em> for more complete
       output.
      </dd>
     <dt>--hidden (-H)</dt>
      <dd>
       Windows only. Hides the application window and disables all message boxes,
       overriding any <em>--show</em> option. This is useful when running as a windows
       service.
      </dd>
     <dt>--idle-timeout &lt;time&gt;</dt>
      <dd>
       Specifies a timeout (in seconds) for receiving network traffic from remote
       SMTP and POP clients. The default is 1800 seconds.
      </dd>
     <dt>--immediate (-m)</dt>
      <dd>
       Causes mail messages to be forwarded as they are received, even before they
       have been accepted. This can be used to do proxying without
       store-and-forward, but in practice clients tend to to time out while
       waiting for their mail message to be accepted.
      </dd>
     <dt>--interface &lt;ip-address-list&gt; (-I)</dt>
      <dd>
       Specifies the IP network addresses or interface names used to bind listening
       ports. By default listening ports for incoming SMTP, POP and administration
       connections will bind the 'any' address for IPv4 and for IPv6, ie.
       <em>0.0.0.0</em> and <em>::</em>. Multiple addresses can be specified by using the option
       more than once or by using a comma-separated list. Use a prefix of <em>smtp=</em>,
       <em>pop=</em> or <em>admin=</em> on addresses that should apply only to those types of
       listening port. Any link-local IPv6 addresses must include a zone name or
       scope id.  Interface names can be used instead of addresses, in which case
       all the addresses associated with that interface at startup will used for
       listening. When an interface name is decorated with a <em>-ipv4</em> or <em>-ipv6</em>
       suffix only their IPv4 or IPv6 addresses will be used (eg. <em>ppp0-ipv4</em>).
      </dd>
     <dt>--localedir &lt;dir&gt;</dt>
      <dd>
       Enables localisation and specifies the locale base directory where message
       catalogues can be found. An empty directory can be used for the built-in
       default.
      </dd>
     <dt>--log (-l)</dt>
      <dd>
       Enables logging to the standard error stream and to the syslog. The
       <em>--close-stderr</em> and <em>--no-syslog</em> options can be used to disable output to
       standard error stream and the syslog separately. Note that <em>--as-server</em>,
       <em>--as-client</em> and <em>--as-proxy</em> imply <em>--log</em>, and <em>--as-server</em> and
       <em>--as-proxy</em> also imply <em>--close-stderr</em>.
      </dd>
     <dt>--log-address</dt>
      <dd>
       Adds the network address of remote clients to the logging output.
      </dd>
     <dt>--log-file &lt;file&gt; (-N)</dt>
      <dd>
       Redirects standard-error logging to the specified file. Logging to the log
       file is not affected by <em>--close-stderr</em>. The filename can include <em>%d</em> to
       get daily log files; the <em>%d</em> is replaced by the current date in the local
       timezone using a <em>YYYYMMDD</em> format.
      </dd>
     <dt>--log-time (-L)</dt>
      <dd>
       Adds a timestamp to the logging output using the local timezone.
      </dd>
     <dt>--no-daemon (-t)</dt>
      <dd>
       Disables the normal backgrounding at startup so that the program runs in the
       foreground, without forking or detaching from the terminal.  On Windows
       this disables the system tray icon so the program uses a normal window;
       when the window is closed the program terminates.
      </dd>
     <dt>--no-smtp (-X)</dt>
      <dd>
       Disables listening for incoming SMTP connections.
      </dd>
     <dt>--no-syslog (-n)</dt>
      <dd>
       Disables logging to the syslog. Note that <em>--as-client</em> implies
       <em>--no-syslog</em>.
      </dd>
     <dt>--pid-file &lt;pid-file&gt; (-i)</dt>
      <dd>
       Causes the process-id to be written into the specified file when the program
       starts up, typically after it has become a backgroud daemon.
      </dd>
     <dt>--poll &lt;period&gt; (-O)</dt>
      <dd>
       Causes forwarding of spooled mail messages to happen at regular intervals
       (with the time given in seconds).
      </dd>
     <dt>--pop (-B)</dt>
      <dd>
       Enables the POP server listening, by default on port 110, providing access to
       spooled mail messages. Negotiated TLS using the POP <em>STLS</em> command will be
       enabled if the <em>--server-tls</em> option is also given.
      </dd>
     <dt>--pop-auth &lt;file&gt; (-F)</dt>
      <dd>
       Specifies a file containing valid POP account details. The file format is the
       same as for the SMTP server secrets file, ie. lines starting with <em>server</em>,
       with user-id and password in the third and fourth fields. A special value
       of <em>/pam</em> can be used for authentication using linux PAM.
      </dd>
     <dt>--pop-by-name (-J)</dt>
      <dd>
       Modifies the spool directory used by the POP server to be a sub-directory
       with the same name as the POP authentication user-id. This allows multiple
       POP clients to read the spooled messages without interfering with each
       other, particularly when also using <em>--pop-no-delete</em>. Content files can
       stay in the main spool directory with only the envelope files copied into
       user-specific sub-directories. The <em>emailrelay-filter-copy</em> program is a
       convenient way of doing this when run via <em>--filter</em>.
      </dd>
     <dt>--pop-no-delete (-G)</dt>
      <dd>
       Disables the POP DELE command so that the command appears to succeed but mail
       messages are not deleted from the spool directory.
      </dd>
     <dt>--pop-port &lt;port&gt; (-E)</dt>
      <dd>
       Sets the POP server's listening port number.
      </dd>
     <dt>--port &lt;port&gt; (-p)</dt>
      <dd>
       Sets the port number used for listening for incoming SMTP connections.
      </dd>
     <dt>--prompt-timeout &lt;time&gt; (-w)</dt>
      <dd>
       Specifies a timeout (in seconds) for getting the initial prompt from a remote
       SMTP server. If no prompt is received after this time then the SMTP dialog
       goes ahead without it.
      </dd>
     <dt>--remote-clients (-r)</dt>
      <dd>
       Allows incoming connections from addresses that are not local. The default
       behaviour is to reject connections that are not local in order to prevent
       accidental exposure to the public internet, although a firewall should also
       be used. Local address ranges are defined in RFC-1918, RFC-6890 etc.
      </dd>
     <dt>--response-timeout &lt;time&gt; (-T)</dt>
      <dd>
       Specifies a timeout (in seconds) for getting responses from remote SMTP
       servers. The default is 1800 seconds.
      </dd>
     <dt>--server-auth &lt;file&gt; (-S)</dt>
      <dd>
       Enables SMTP server authentication of remote SMTP clients. Account names and
       passwords are taken from the specified secrets file. The secrets file
       should contain lines that have four space-separated fields, starting with
       <em>server</em> in the first field; the second field is the password encoding
       (<em>plain</em> or <em>md5</em>), the third is the client user-id and the fourth is the
       password. The user-id is RFC-1891 xtext encoded, and the password is either
       xtext encoded or generated by <em>emailrelay-passwd</em>. A special value of
       <em>/pam</em> can be used for authentication using linux PAM.
      </dd>
     <dt>--server-auth-config &lt;config&gt;</dt>
      <dd>
       Configures the SMTP server authentication module using a semicolon-separated
       list of configuration items. Each item is a single-character key, followed
       by a colon and then a comma-separated list. A 'm' character introduces a
       preferred sub-set of the built-in authentication mechanisms, and an 'x' is
       used for blocklisted mechanisms.
      </dd>
     <dt>--server-tls (-K)</dt>
      <dd>
       Enables TLS for incoming SMTP and POP connections. SMTP clients can then
       request TLS encryption by issuing the STARTTLS command. The
       <em>--server-tls-certificate</em> option must be used to define the server
       certificate.
      </dd>
     <dt>--server-tls-certificate &lt;pem-file&gt;</dt>
      <dd>
       Defines the TLS certificate file when acting as a SMTP or POP server. This
       file must contain the server's private key and certificate chain using the
       PEM file format. Keep the file permissions tight to avoid accidental
       exposure of the private key.
      </dd>
     <dt>--server-tls-connection</dt>
      <dd>
       Enables SMTP over TLS when acting as an SMTP server. This is for SMTP over
       TLS (SMTPS), not TLS negotiated within SMTP using STARTTLS.
      </dd>
     <dt>--server-tls-required</dt>
      <dd>
       Makes the use of TLS mandatory for any incoming SMTP and POP connections.
       SMTP clients must use the STARTTLS command to establish a TLS session
       before they can issue SMTP AUTH or SMTP MAIL-TO commands.
      </dd>
     <dt>--server-tls-verify &lt;ca-list&gt;</dt>
      <dd>
       Enables verification of remote SMTP and POP clients' certificates against any
       of the trusted CA certificates in the specified file or directory. In many
       use cases this should be a file containing just your self-signed root
       certificate.
      </dd>
     <dt>--size &lt;bytes&gt; (-M)</dt>
      <dd>
       Limits the size of mail messages that can be submitted over SMTP.
      </dd>
     <dt>--spool-dir &lt;dir&gt; (-s)</dt>
      <dd>
       Specifies the directory used for holding mail messages that have been
       received but not yet forwarded.
      </dd>
     <dt>--syslog[=&lt;facility&gt;] (-k)</dt>
      <dd>
       When used with <em>--log</em> this option enables logging to the syslog even if the
       <em>--no-syslog</em> option is also used. This is typically used as a convenient
       override when using <em>--as-client</em>.
      </dd>
     <dt>--tls-config &lt;options&gt; (-9)</dt>
      <dd>
       Selects and configures the low-level TLS library, using a comma-separated
       list of keywords. If OpenSSL and mbedTLS are both built in then keywords of
       <em>openssl</em> and <em>mbedtls</em> will select one or the other. Keywords like
       <em>tlsv1.0</em> can be used to set a minimum TLS protocol version, or <em>-tlsv1.2</em>
       to set a maximum version.
      </dd>
     <dt>--user &lt;username&gt; (-u)</dt>
      <dd>
       When started as root the program switches to a non-privileged effective
       user-id when idle. This option can be used to define the idle user-id and
       also the group ownership of new files and sockets. Specify <em>root</em> to
       disable all user-id switching. Ignored on Windows.
      </dd>
     <dt>--verbose (-v)</dt>
      <dd>
       Enables more verbose logging when used with <em>--log</em>, and more verbose help
       when used with <em>--help</em>.
      </dd>
     <dt>--version (-V)</dt>
      <dd>
       Displays version information and then exits.
      </dd>
    </dl>
    <p>
     A configuration file can be used to provide additional options; put each
     option on a separate line, use the long option names but without the double
     dash, and separate the option name from the option value with spaces.
    </p>

    <p>
     All command-line options that specify a filename can use a special <em>@app</em>
     substitution variable that is interpreted as the directory that contains
     the <em>emailrelay</em> executable or MacOS application bundle.
    </p>
   <h2><a class="a-header" name="SH_1_2">Message store</a></h2> <!-- index:2:SH:1:2:Message store -->
    <p>
     Mail messages are stored as text files in the configured spool directory. Each
     e-mail message is represented as an envelope file and a content file. The
     envelope file contains parameters relevant to the SMTP dialogue, and the
     content file contains the RFC-822 headers and body text.
    </p>

    <p>
     The filenames used in the message store have a prefix of <em>emailrelay</em>, followed
     by a process-id, timestamp and sequence number, and then <em>envelope</em> or
     <em>content</em>. The envelope files then have an additional suffix to implement a
     simple locking scheme.
    </p>

    <p>
     The envelope file suffixes are:
    </p>

    <ul>
     <li><em>.new</em> -- while the envelope is first being written</li>
     <li><em>.busy</em> -- while the message is being forwarded</li>
     <li><em>.bad</em> -- if the message cannot be forwarded</li>
     <li><em>.local</em> -- for copies of the envelope file for delivery to local recipients</li>
    </ul>

    <p>
     If an e-mail message cannot be forwarded the envelope file is given a <em>.bad</em>
     suffix, and the failure reason is written into the file.
    </p>
   <h2><a class="a-header" name="SH_1_3">Forwarding</a></h2> <!-- index:2:SH:1:3:Forwarding -->
    <p>
     Spooled e-mail messages can be forwarded at various times, depending on the
     command-line options:
    </p>

    <ul>
     <li>when E-MailRelay first starts up (<em>--as-client</em> or <em>--forward</em>)</li>
     <li>as each message is submitted, just before receipt is acknowledged (<em>--immediate</em>)</li>
     <li>as soon as the submitting client connection disconnects (<em>--forward-on-disconnect</em>)</li>
     <li>periodically (<em>--poll=<seconds></em>)</li>
     <li>on demand using the administration interface's <em>forward</em> command (<em>--admin=<port></em>)</li>
     <li>when a <em>--filter</em> script exits with an exit code of 103</li>
    </ul>

    <p>
     These can be mixed.
    </p>

    <p>
     When using <em>--as-client</em>, or <em>--dont-serve</em> and <em>--forward</em>, the spooled
     messages begin to be forwarded as soon as the program starts up, and the
     program terminates once they have all been sent.
    </p>

    <p>
     By default all recipient e-mail addresses must be accepted by the remote server
     when E-MailRelay forwards an e-mail message. If any one recipient is rejected
     then the message will be left in the spool directory with a <em>.bad</em> suffix on
     the envelope file. This behaviour can be changed by using <em>--forward-to-some</em>
     command-line option so that forwarding will succeed for the valid recipients
     and the failed message will contain the invalid ones.
    </p>
   <h2><a class="a-header" name="SH_1_4">Mail processing</a></h2> <!-- index:2:SH:1:4:Mail processing -->
    <p>
     The <em>--filter</em> command-line option allows you to specify a mail processing
     program which operates on e-mail messages as they pass through the E-MailRelay
     system. The filter program is run as soon as the e-mail message has been stored
     in the spool directory, with the full path of the content file and envelope
     file put on the command-line.
    </p>

    <p>
     For example, the following command will start a proxy server on port 587
     which processes mail using the specified filter program, and then forwards the
     mail on to the system's default MTA (on port 25):
    </p>

      <div class="div-pre">
       <pre>emailrelay --as-proxy=localhost:smtp --port=587 --no-syslog \
  --filter=$HOME/myfilter --spool-dir=$HOME/spool
</pre>
      </div><!-- div-pre -->
    <p>
     The filter program should terminate with an exit code of zero to indicate
     success, or a value between 1 and 99 to indicate failure. Exit codes between
     100 and 115 are reserved for special processing: 100 is used to abandon the
     current e-mail message (so the filter can delete the files), and 103 has the
     effect of requesting a rescan of the spool directory if forwarding is
     enabled (typically to pick up on new messages that the filter program has
     created).
    </p>

    <p>
     If the filter program terminates with a non-zero exit code then the first few
     thousand characters of the standard output stream are searched for a line
     starting with <em><<error text>></em> or <em>[[error text]]</em>. The text inside is taken
     as a failure reason, and passed back to the SMTP client. A second error-text
     line can be used for additional diagnostics that will not be visible to the
     remote client.
    </p>

    <p>
     The filter program can edit any part of the e-mail message's envelope file or
     content file: E-MailRelay remembers nothing about the e-mail message while the
     filter is running except the filename. However, if the message is deleted by
     the filter program then E-MailRelay will complain, so to avoid the error
     message use an exit code of 100.
    </p>

    <p>
     If the filter program creates completely new e-mail messages in the spool
     directory then they may not be processed immediately, or they may be completely
     ignored.  To get E-MailRelay to pick up any new messages you create in the
     spool directory use the special 103 exit code, or rely on the <em>--poll</em>
     mechanism, or perhaps run <em>emailrelay --as-client</em> from within the filter
     program.
    </p>

    <p>
     As an example of a simple filter program processor this shell script examines
     the sending client's IP address and conditionally passes the message into
     <em>sendmail</em> (using the sendmail command-line interface rather than SMTP):
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# filter.sh
content="${1}"
envelope="${2}"
ip="`awk '/MailRelay-Client:/ {print $2;exit}' \"${envelope}\"`"
if test "${ip}" = "192.168.0.2"
then
    /usr/sbin/sendmail -t &lt; "${content}"
    rm -f "${envelope}" "${content}"
    exit 100 # &lt;= cancel further processing by emailrelay
fi
exit 0
</pre>
      </div><!-- div-pre -->
    <p>
     The first thing this script does is convert the path of the content file which
     it is given, into the corresponding envelope file. It then extracts the
     client's IP address out of the envelope file using <em>awk</em>. If this matches the
     fixed address then it pipes the message content into sendmail, deletes the
     e-mail message and exits with a value of 100. The exit value of 100 tells
     E-MailRelay to forget the message, and not to complain about the files
     disappearing.
    </p>

    <p>
     For Windows this example can be rewritten in JavaScript:
    </p>

      <div class="div-pre">
       <pre>// filter.js
var content = WScript.Arguments(0) ;
var envelope = WScript.Arguments(1) ;
var fs = WScript.CreateObject( "Scripting.FileSystemObject" ) ;
var ts = fs.OpenTextFile( envelope , 1 , false ) ;
var e = ts.ReadAll() ;
ts.Close() ;
var re = new RegExp( "MailRelay-Client: \(.*\)" ) ;
var ip = e.match(re)[1] ;
if( ip === "192.168.0.2" )
{
    var sh = WScript.CreateObject( "Wscript.Shell" ) ;
    sh.Run( "sendmail " + content ) ; // bogus
    fs.DeleteFile( content ) ;
    fs.DeleteFile( envelope ) ;
    WScript.Quit( 100 )
}
WScript.Quit( 0 ) ;
</pre>
      </div><!-- div-pre -->
    <p>
     Windows filter programs written in JavaScript can be run with an E-MailRelay
     <em>--filter</em> option something like this:
    </p>

      <div class="div-pre">
       <pre>--filter="C:/Program Files/E-MailRelay/filter.js"
</pre>
      </div><!-- div-pre -->
    <p>
     Note that double-quotes are needed because the file path contains a space.
     Either forward-slashes or back-slashes can be used.
    </p>

    <p>
     E-MailRelay also has a <em>--client-filter</em> option that enables processing of
     e-mail messages just before they are forwarded, rather than after they are
     stored. The disadvantage is that by then it is too late to notify the
     submitting SMTP client of any processing failures, so in many store-and-forward
     applications using <em>--filter</em> is more useful. The special exit code of 100 can
     be used to ignore the current message, and 102 to stop scanning for more
     spooled messages after processing the current one (eg. for simple
     rate-limiting).
    </p>

    <p>
     Bear in mind the following points when writing <em>--filter</em> programs:
    </p>

    <ul>
     <li>The standard input and output are not used; the message filename is passed on the command-line.</li>
     <li>Programs are run with a reduced set of environment variables.</li>
     <li>E-MailRelay files use CR-LF line terminators, as required by the RFCs.</li>
     <li>Envelope files will have a file extension of <em>.new</em> or <em>.busy</em> when the program runs.</li>
     <li>Windows scripts may need to be run via <em>cscript</em> or a batch file wrapper.</li>
    </ul>

    <p>
     It is also possible to do message filtering in a separate process by using
     <em>net:<tcp-address></em> as the <em>--filter</em> or <em>--client-filter</em> option parameter.
     E-MailRelay connects to this address and then uses a simple line-based dialog
     as each e-mail message is processed: it sends the full path of the message
     content file in one line and expects the remote process to respond with an <em>ok</em>
     line if the message is to be accepted or an error message. If the error message
     contains a tab character then anything after the tab character is logged but
     otherwise ignored.
    </p>

    <p>
     Alternatively, use <em>spam:<tcp-address></em> or <em>spam-edit:<tcp-address></em> to connect
     to a SpamAssassim <em>spamd</em> server, or use <em>exit:<exit-code></em> for simulating a
     filter program that just does an exit with the specified exit code.
    </p>
   <h2><a class="a-header" name="SH_1_5">Authentication</a></h2> <!-- index:2:SH:1:5:Authentication -->
    <p>
     E-MailRelay can perform <em>client-side</em> authentication when connecting to remote
     SMTP servers, and <em>server-side</em> authentication when remote clients connect to
     the E-MailRelay server.
    </p>

    <p>
     SMTP authentication is enabled with the <em>--client-auth</em> and <em>--server-auth</em>
     command-line options, followed by the name of a 'secrets' file containing
     usernames and passwords:
    </p>

      <div class="div-pre">
       <pre>emailrelay --as-server --server-auth=/etc/emailrelay-client.auth
emailrelay --as-client=example.com:smtp --client-auth=/etc/emailrelay-server.auth
</pre>
      </div><!-- div-pre -->
    <p>
     The client-side secrets file specified with <em>--client-auth</em> is used when
     E-MailRelay acts as a client to talk to a remote server. The file should
     contain at least one <em>client</em> entry.
    </p>

    <p>
     The server-side secrets file specified with <em>--server-auth</em> is used when a
     remote client tries to authenticate with the E-MailRelay server. The file
     should normally contain several <em>server</em> entries, one for each remote client.
    </p>

<img src="authentication.png" alt="image">


    <p>
     The same secrets file may be specified for both <em>--client-auth</em> and
     <em>--server-auth</em> options.
    </p>

    <p>
     The secrets file has a line-based format: blank lines are ignored and the hash
     character (#) is used for comments.
    </p>

    <p>
     Lines have four white-space delimited fields:
    </p>

    <ul>
     <li><em>client-or-server</em></li>
     <li><em>password-type</em></li>
     <li><em>userid</em></li>
     <li><em>password</em></li>
    </ul>

    <p>
     The <em>client-or-server</em> field must be <em>client</em> or <em>server</em>; the <em>password-type</em>
     field should be <em>plain</em> or <em>md5</em>; the <em>userid</em> field is xtext-encoded
     user identifier; and the <em>password</em> field is the xtext-encoded plain password
     or a base64-encoded <em>HMAC-MD5</em> state. For <em>client</em> lines the password-type can
     also be <em>oauth</em>.
    </p>

    <p>
     The <em>xtext</em> encoding scheme is defined properly in RFC-3461, but basically it
     says that non-alphanumeric characters (including space, <em>+</em>, <em>#</em> and <em>=</em>) should
     be represented in uppercase hexadecimal ascii as <em>+XX</em>. So a space should be
     written as <em>+20</em>; <em>+</em> as <em>+2B</em>; <em>#</em> as <em>+23</em>; and <em>=</em> as <em>+3D</em>.
    </p>

    <p>
     Base64 encoding can be used instead of xtext encoding for the user identifier
     and plain password by replacing <em>plain</em> by <em>plain:b</em>.
    </p>

    <p>
     Note that modern email services will expect userids and passwords containing
     non-ASCII characters to use UTF-8 encoding with RFC-4013 normalisation applied.
    </p>

    <p>
     Authentication proceeds according to an authentication 'mechanism' that is
     advertised by the server and selected by the client. Many authentication
     mechanisms have been defined and standardised, and the simplest ones just
     exchange a username and plaintext password. E-MailRelay supports the PLAIN,
     LOGIN and CRAM-MD5 mechanisms for both client-side and server-side
     authentication as a minimum, but other mechanisms might be built in or
     available via PAM (see below).
    </p>

    <p>
     The PLAIN, LOGIN and CRAM-MD5 mechanisms can use plaintext passwords, stored
     in the secrets file using a password-type of <em>plain</em>. In addition, the
     CRAM-MD5 mechanism can also make use of hashed passwords generated by the
     <em>emailrelay-passwd</em> program and these are stored in the secrets file with a
     password-type of <em>md5</em>. (Hashed passwords are marginally more secure because
     the plaintext password which might be used on other accounts is not easily
     recovered. However, hashed passwords can only be used for HMAC authentication
     mechanisms that are based on the same hash function.) The XOAUTH2 mechanism
     can be used for client-side authentication using tokens that have been
     recently obtained from a third-party authentication server and added to the
     secrets file with a password-type of <em>oauth</em>.
    </p>

    <p>
     In the following example <em>bob</em> is the username that E-MailRelay uses when
     it authenticates with a remote SMTP server, and two usernames (<em>alice</em> and
     <em>carol</em>) can be used by remote clients when they authenticate with the
     E-MailRelay server:
    </p>

      <div class="div-pre">
       <pre>#
# emailrelay secrets file
#
client plain bob password123
server plain alice e+3Dmc2
server plain carol my+20password
</pre>
      </div><!-- div-pre -->
    <p>
     Using <em>MD5</em> hashes the same users would look like this:
    </p>

      <div class="div-pre">
       <pre>#
# emailrelay secrets file
#
client md5 bob 9N2IRYVXqu7SkOW1Xat+wpR9NbA2R6fb61XlmqW+46E=
server md5 alice v1HOpuLIbbvgoJjhueeoqwfvtIp2C+gMA285ke+xxow=
server md5 carol x6UJKQF9f7HfhS1M+PW4s8rXIoT+L+WoqLz+rBwSKbw=
</pre>
      </div><!-- div-pre -->
    <p>
     When the <em>--server-auth</em> option is used clients must authenticate with the
     E-MailRelay server but it is possible to configure some client IP addresses as
     'trusted' so that connections from these addresses do not have to authenticate.
    </p>

    <p>
     Trusted IP addresses are configured with lines in the secrets file having
     <em>server</em> in the first field, <em>none</em> in the second field, a wildcarded IP
     address in the third field, and an arbitrary keyword in the fourth field. The
     keyword field is passed to any external address verifier program specified by
     the <em>--address-verifier</em> command-line option; it is not used for any other
     purpose. Wildcarded IPv4 addresses can use a format like 192.168.0.0/24 or
     192.168.0.*.
    </p>

    <p>
     For example, this secrets file allows any client connecting over IPv4 from the
     192.168.0.0/24 address range, or over IPv6 from the fe80::/64 or fc00::/7
     ranges, to connect without authentication:
    </p>

      <div class="div-pre">
       <pre>#
# emailrelay secrets file
#
server none 192.168.0.* localipv4
server none fe80::/64 localipv6
server plain alice e+3Dmc2
server plain carol my+20password
</pre>
      </div><!-- div-pre -->
    <p>
     On the client side, authentication is performed when E-MailRelay connects to a
     server that implements the SMTP AUTH extension with one of the supported
     mechanisms. If client-side authentication is required but the remote server
     does not support the AUTH extension, or does not support mechanisms for which
     E-MailRelay has secrets, then an error will be logged and no messages will be
     forwarded.
    </p>

    <p>
     When E-MailRelay successfully authenticates with the remote server the
     authentication name is passed as the AUTH parameter of the SMTP MAIL FROM
     command, ignoring any AUTH name from the original submission. This default
     policy can be modified by editing the <em>MailFromAuthOut</em> field in the message
     envelope file, perhaps by using a <em>--filter</em> or <em>--client-filter</em> program. The
     value in this envelope field should be empty for the default policy, <em><></em> for
     no AUTH name, or an xtext-encoded authentication name.
    </p>

    <p>
     The TLS layer can also be used for authentication, independently of SMTP, as
     described below.
    </p>
   <h2><a class="a-header" name="SH_1_6">TLS encryption</a></h2> <!-- index:2:SH:1:6:TLS encryption -->
    <p>
     E-MailRelay can use negotiated TLS to encrypt SMTP and POP sessions: use the
     <em>--client-tls</em> command-line option to enable client-side TLS encryption when
     E-MailRelay is acting as an SMTP client, and use <em>--server-tls</em> to enable
     server-side TLS when E-MailRelay is acting as an SMTP or POP server. The
     connections start off as unencrypted and the SMTP command <em>STARTTLS</em> (or the
     POP <em>STLS</em> command) can be used to negotiate TLS encryption before any
     passwords are exchanged.
    </p>

    <p>
     The <em>--server-tls</em> option requires that the <em>--server-tls-certificate</em> option
     is used to specify a PEM-format file containing a X.509 certificate and private
     key.
    </p>

    <p>
     This OpenSSL command can be used to create a self-signed certificate file
     suitable for testing:
    </p>

      <div class="div-pre">
       <pre>$ openssl req -x509 -nodes -subj "/CN=$USER" -newkey rsa:2048 -keyout emailrelay.pem  -out emailrelay.pem
</pre>
      </div><!-- div-pre -->
    <p>
     TLS performs encryption to prevent eavesdropping, but it does not necessarily
     do authentication to prevent man-in-the-middle attacks. For full TLS
     authentication you must use private keys and X.509 certificates symmetrically
     on both ends, with TLS verification enabled in both directions. Refer to the
     documentation of all the <em>--server-tls...</em> and <em>--client-tls...</em> command-line
     options for more details.
    </p>

    <p>
     E-MailRelay can also make outgoing SMTP connections using TLS encryption where
     the whole SMTP dialog is encrypted from the start (<em>--client-tls-connection</em>).
     This is sometimes called SMTP-over-TLS or secure SMTP (smtps) or implicit TLS
     and it is normally used with port number 465.
    </p>

    <p>
     Similarly, when using <em>--server-tls-connection</em> the E-MailRelay server will
     expect all connections to be using TLS from the start, so the whole SMTP
     dialogue is encrypted, without the need for <em>STARTTLS</em>.
    </p>
   <h2><a class="a-header" name="SH_1_7">PAM Authentication</a></h2> <!-- index:2:SH:1:7:PAM Authentication -->
    <p>
     E-MailRelay on Linux supports the use of PAM (Pluggable Authentication Modules)
     for authentication if it has been built with the <em>--with-pam</em> configure option.
    </p>

    <p>
     PAM authentication can be used to authenticate SMTP and POP connections coming
     in from remote clients; it cannot be used by E-MailRelay to supply passwords
     when acting as an SMTP client.
    </p>

    <p>
     Use <em>--server-auth=/pam</em> and/or <em>--pop-auth=/pam</em> on the command-line to use
     PAM authentication for SMTP and POP respectively. The E-MailRelay server will
     then advertise an SMTP authentication mechanism of PLAIN and do the actual
     authentication via PAM.
    </p>

    <p>
     The PAM system itself must be configured with a service of <em>emailrelay</em>. This
     normally involves creating a file <em>/etc/pam.d/emailrelay</em> containing something
     like the following:
    </p>

      <div class="div-pre">
       <pre>auth requisite pam_unix.so nullok_secure
session required pam_permit.so
account required pam_permit.so
password required pam_deny.so
</pre>
      </div><!-- div-pre -->
    <p>
     With this configuration the E-MailRelay server will use normal unix system
     account names and passwords to authenticate remote clients. On some systems
     this will require special permissioning to allow the E-MailRelay server to
     read the shadow password database.
    </p>

    <p>
     When using PAM authentication E-MailRelay requires that remote clients
     establish an encrypted session using TLS before authentication can proceed.
    </p>
   <h2><a class="a-header" name="SH_1_8">IP addresses</a></h2> <!-- index:2:SH:1:8:IP addresses -->
    <p>
     By default the E-MailRelay server listens for connections on the wildcard IPv4
     and IPv6 addresses, and when making outgoing connections it does not explicitly
     bind any address to the the local socket.
    </p>

    <p>
     If a single network address is specified with the <em>--interface</em> command-line
     option then that address is used for listening.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface 127.0.0.1
</pre>
      </div><!-- div-pre -->
    <p>
     If the <em>--client-interface</em> option is used then that address is used to bind
     the local end of outgoing SMTP client connections.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--client-interface 192.168.0.1
</pre>
      </div><!-- div-pre -->
    <p>
     More than one address can be given in the <em>--interface</em> option separated by
     commas, or multiple <em>--interface</em> options can be used. All of those addresses
     will be used for listening.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface 192.168.0.1,127.0.0.1,fc00::1,::1
--interface 192.168.0.1 --interface 127.0.0.1 --interface fc00::1 --interface ::1
</pre>
      </div><!-- div-pre -->
    <p>
     On some systems interface names can be used, in which case all the addresses
     associated with that interface are used for listening.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface eth0
</pre>
      </div><!-- div-pre -->
    <p>
     The interface name can have a <em>-ipv4</em> or <em>-ipv6</em> suffix to limit the listening
     addresses to one address family.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface eth0-ipv4
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>--interface</em> option can also have one of the prefixes <em>smtp=</em>, <em>pop=</em> or
     <em>admin=</em> so that it is only used in that context.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface smtp=192.168.0.1 --interface pop=127.0.0.1 --interface admin=127.0.0.1
--interface smtp=eth0-ipv4,pop=eth1-ipv6
</pre>
      </div><!-- div-pre -->
    <p>
     The IPv4 and IPv6 wildcard addresses (<em>0.0.0.0</em> and <em>::</em>) can be used with
     <em>--interface</em> and <em>--client-interface</em> to enable the use of IPv4 only or IPv6
     only.
    </p>

    <p>
     To use IPv4 only for incoming connections use <em>--interface 0.0.0.0</em>; for IPv6
     only on incoming connections use <em>--interface ::</em>.
    </p>

      <div class="div-pre">
       <pre>--interface 0.0.0.0 # IPv4 only
--interface ::      # IPv6 only
</pre>
      </div><!-- div-pre -->
    <p>
     To use IPv4 only on outgoing SMTP connection use <em>--client-interface 0.0.0.0</em>;
     for IPv6 only on outgoing SMTP connections use <em>--client-interface ::</em>.
    </p>

      <div class="div-pre">
       <pre>--client-interface 0.0.0.0 # IPv4 only
--client-interface ::      # IPv6 only
</pre>
      </div><!-- div-pre -->
    <p>
     Hostnames given in the <em>--forward-to</em>, <em>--as-proxy</em> and <em>--as-client</em> options
     are resolved to IPv4 addresses and/or IPv6 addresses using DNS. If both IPv4
     and IPv6 records are returned from the DNS query then the <em>--client-interface</em>
     option can be used to select either the IPv4 or IPv6 results. Otherwise the
     first address is used, whether that is IPv4 or IPv6.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--as-client ipv4or6.example.com:25 --client-interface 0.0.0.0
--as-client ipv4or6.example.com:25 --client-interface ::</pre>
      </div><!-- div-pre -->
   <h2><a class="a-header" name="SH_1_9">Unix domain sockets</a></h2> <!-- index:2:SH:1:9:Unix domain sockets -->
    <p>
     E-MailRelay on Unix will listen on unix-domain sockets instead of IPv4 or IPv6
     if the <em>--interface</em> option is given as an absolute file-system path:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface=/run/smtp.s --port=0
</pre>
      </div><!-- div-pre -->
    <p>
     When listening on more than one unix-domain socket use the extended form of the
     <em>--interface</em> option with a prefix of <em>smtp=</em>, <em>pop=</em>, or <em>admin=</em>:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface=smtp=/run/smtp.s --port=0 --interface=pop=/run/pop.s --pop --pop-port=0
</pre>
      </div><!-- div-pre -->
    <p>
     The forwarding address can also be a unix-domain address:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--forward-to=/run/smtp.s
</pre>
      </div><!-- div-pre -->
    <p>
     And it is also possible to communicate with message filters over a unix-domain
     socket:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--filter=net:/run/filter.s
--filter=spam:/run/spamd.s
--filter=spam-edit:/run/spamd.s</pre>
      </div><!-- div-pre -->
   <h2><a class="a-header" name="SH_1_10">SOCKS</a></h2> <!-- index:2:SH:1:10:SOCKS -->
    <p>
     E-MailRelay can use a SOCKS 4a proxy for establishing outgoing SMTP
     connections; just append the SOCKS proxy address to the SMTP server's address,
     separated by <em>@</em>.
    </p>

    <p>
     For example, this could be used to send e-mails via the Tor network, assuming
     there is a local Tor node running on port 9050:
    </p>

      <div class="div-pre">
       <pre>emailrelay --forward-to example.com:smtp@localhost:9050 ...
</pre>
      </div><!-- div-pre -->
    <p>
     The Tor system will then be used to resolve the <em>example.com</em> domain name and
     establish the connection. The target SMTP server will see a connection coming
     from the Tor exit node rather than from the E-MailRelay server.
    </p>
   <h2><a class="a-header" name="SH_1_11">Address verification</a></h2> <!-- index:2:SH:1:11:Address verification -->
    <p>
     By default the E-MailRelay server will accept all recipient addresses for
     incoming e-mails as valid. This default behaviour can be modified by using an
     external verifier program, specified with the <em>--address-verifier</em> command-line
     option, so that you get to choose which recipient addresses are accepted as
     valid and which are rejected.
    </p>

    <p>
     Your verifier program is passed a command-line containing: (1) the recipient
     e-mail address as supplied by the remote client, (2) the <em>from</em> e-mail address
     as supplied by the client, or the empty string in the case of the <em>VRFY</em>
     command, (3) the IP address and port of the far end of the client
     connection, (4) the local fully qualified domain name, (5) the authentication
     mechanism used by the client (if any, and <em>none</em> if trusted), and (6) either
     the authentication name or the fourth field from authentication secrets file
     if a trusted IP address.
    </p>

    <p>
     So, for example, a verifier program called <em>myverifier</em> might be run as if with
     the following command-line:
    </p>

      <div class="div-pre">
       <pre>myverifier bob@local.net alice@example.com 192.168.0.1:123 local.net login alice
</pre>
      </div><!-- div-pre -->
    <p>
     The verifier program is expected to generate two lines of output on the
     standard output stream and then terminate with a specific exit code.
    </p>

    <p>
     For future-proofing a verifier should report a version number of <em>2.0</em> if called
     with a command-line starting with <em>--emailrelay-version</em>.
    </p>

    <p>
     For valid addresses the first line of output is ignored, the second line should
     be copied from the first command-line argument, and the exit value should be
     one.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- accept all (252)
echo ""
echo $1
exit 1
</pre>
      </div><!-- div-pre -->
    <p>
     If the address is valid but it should be delivered to a local mailbox rather
     than forwarded then the verifier program should write two lines to the standard
     output -- the full name associated with the mailbox, and the canonical mailbox
     name -- and then exit with a value of zero.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- accept as local (250)
echo Local Postmaster '&lt;postmaster@localhost&gt;'
echo postmaster
exit 0
</pre>
      </div><!-- div-pre -->
    <p>
     For E-MailRelay local delivery just means that the message files in the spool
     directory are copied to files with a <em>.local</em> filename suffix. If all the
     envelope recipients are local-mailboxes then no normal message files are
     created. This mechanism can be used to create a separate channel for
     administrative messages such as delivery reports.
    </p>

    <p>
     For invalid addresses the exit value should be non-zero and the first line
     of output is the error response. A second output line can be used for
     diagnostic information that gets put into the E-MailRelay log file.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- reject as invalid (550)
echo invalid mailbox: $1
exit 2
</pre>
      </div><!-- div-pre -->
    <p>
     To indicate a temporary failure this can be changed to an exit code of 3.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- reject as temporarily invalid (450)
echo mailbox unavailable: $1
exit 3
</pre>
      </div><!-- div-pre -->
    <p>
     If the verifier exit code is 100 then the connection is aborted immediately,
     which may be useful in limiting the impact of denial of service attacks:
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- abort
exit 100
</pre>
      </div><!-- div-pre -->
    <p>
     Any other exit code, from 4 to 99 or 101 and above, behaves in the same way
     as an exit code of 2.
    </p>

    <p>
     In this more complete example the verifier script accepts all addresses as
     valid as long as they contain an <em>at</em> character:
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- accept only if containing an at sign
address="$1"
expr "$address" : ".*@" &gt; /dev/null || exit 2
echo ""
echo "$address"
exit 1 # accept
</pre>
      </div><!-- div-pre -->
    <p>
     As another example, this verifier script accepts all recipient addresses by
     default but rejects remote addresses if the client has bypassed authentication
     by connecting on a trusted IP address:
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier
if test "$1" = "--emailrelay-version" ; then echo 2.0 ; exit 0 ; fi
address="$1"
local_domain="$4"
auth_mechanism="$5"
host="`echo \"$address\" | sed 's/.*@//'`"
if test "$auth_mechanism" = "none" -a "$host" != "$local_domain"
then
    echo "cannot relay without authentication"
    exit 2 # reject the recipient address
fi
echo ""
echo "$address"
exit 1 # accept the recipient address
</pre>
      </div><!-- div-pre -->
    <p>
     or written in JavaScript for Windows:
    </p>

      <div class="div-pre">
       <pre>// verifier.js
if( WScript.Arguments(0) === "--emailrelay-version" )
{
    WScript.Stdout.WriteLine( "2.0" ) ;
    WScript.Quit( 0 ) ;
}
try
{
    var address = WScript.Arguments(0) ;
    var local_domain = WScript.Arguments(3) ;
    var auth_mechanism = WScript.Arguments(4) ;
    var host = address.split(/@/)[1] || "" ;
    if( ( auth_mechanism === "none" || !auth_mechanism ) && host !== local_domain )
    {
        WScript.Stdout.WriteLine( "cannot relay without authentication" ) ;
        WScript.Quit( 2 ) ;
    }
    WScript.Stdout.WriteLine( "" ) ;
    WScript.Stdout.WriteLine( address ) ;
    WScript.Quit( 1 ) ;
}
catch( e )
{
    WScript.Stdout.WriteLine( "mailbox unavailable" ) ;
    WScript.Stdout.WriteLine( e ) ;
    WScript.Quit( 3 ) ;
}
</pre>
      </div><!-- div-pre -->
    <p>
     If this verifier script is used with a suitable <em>--server-auth</em> file then it
     can be used to prevent open relay without restricting authenticated clients.
    </p>

    <p>
     It is also possible to verify addresses in a separate daemon process by using a
     <em>--address-verifier</em> option of the form <em>net:<tcp-address></em>. In this case
     E-MailRelay will connect to the specified verifier daemon over the network and
     send address verification requests as lines with pipe-delimited fields. The
     expected response is another pipe-delimited line containing the same
     information as returned by verifier scripts but in reverse, such as
     <em>0|postmaster|Local Postmaster <postmaster@eg.com></em> or <em>2|mailbox unavailable</em>.
    </p>
   <h2><a class="a-header" name="SH_1_12">Connection blocking</a></h2> <!-- index:2:SH:1:12:Connection blocking -->
    <p>
     All incoming connections from remote network addresses are blocked by default,
     but can be allowed by using the <em>--remote-clients</em>/<em>-r</em> option. This is to
     guard against accidental exposure to the internet.
    </p>

    <p>
     Incoming SMTP connections can also be checked against DNSBL blocklists in order
     to block connections from known spammers. Use the <em>--dnsbl</em> option to define a
     list of DNSBL servers, together with a rejection threshold. If the threshold
     number of servers 'deny' the incoming connection's network address then
     E-MailRelay will drop the connection immediately.
    </p>

    <p>
     The <em>--dnsbl</em> configuration starts with the DNS server transport address and a
     millisecond timeout, followed by the threshold and list of servers:
    </p>

      <div class="div-pre">
       <pre>emailrelay -r --dnsbl 1.1.1.1:53,500,1,spam.example.com,block.example.com ...
</pre>
      </div><!-- div-pre -->
    <p>
     A threshold of zero means that the DNSBL servers are consulted but connections
     are always allowed. This can be combined with verbose logging (<em>--log -v</em>)
     for initial testing.
    </p>

    <p>
     If the timeout period expires before a collective decision is reached then the
     connection is allowed by default. This default behaviour can be changed by
     using a negative timeout, but for finer control use a DNSBL proxy.
    </p>

    <p>
     Connections from loopback and private (RFC-1918) network addresses are never
     checked.
    </p>
   <h2><a class="a-header" name="SH_1_13">Security issues</a></h2> <!-- index:2:SH:1:13:Security issues -->
    <p>
     The following are some security issues that have been taken into consideration:
    </p>

    <dl>
     <dt>Effective userid</dt>
      <dd>
       Suid privileges are revoked at start-up, switching the effective
       userid/groupid to be the real userid/groupid values. If started as <em>root</em>
       then the effective userid/groupid are switched at start-up to those of user
       <em>daemon</em>. Special privileges are only reclaimed when needed to bind sockets
       and do file i/o. Normally this means temporarily switching the userid and
       groupid back to what they were at start-up. However, when writing spool files
       after being started as <em>root</em> only the effective userid is changed, not the
       groupid, so that new files have group ownership corresponding to the
       <em>daemon</em> user.
      </dd>
     <dt>Execution environment</dt>
      <dd>
       The external filter programs are run with an almost empty set of environment
       variables (<em>PATH</em> and <em>IFS</em>), and with no open file descriptors other than
       <em>stdin</em> and <em>stderr</em> open onto <em>/dev/null</em>, and <em>stdout</em> open onto a pipe.
      </dd>
     <dt>Umask</dt>
      <dd>
       The program runs for most of the time with a <em>umask</em> of 177, switching to 117
       when creating spool files.
      </dd>
     <dt>Remote clients</dt>
      <dd>
       By default connections will be rejected if they come from remote machines.
      </dd>
     <dt>Remote configuration</dt>
      <dd>
       No configuration parameters can be changed through the administrative
       interface.
      </dd>
     <dt>Use of exec() and system()</dt>
      <dd>
       No exec(), system() or popen() calls are used other than execve() to spawn the
       mail filter and/or address verifier.
      </dd>
     <dt>File permissions</dt>
      <dd>
       After a normal installation the spool directory is has ownership of
       <em>root.daemon</em> with permissions of <em>-rwxrwxr-x</em> and messages files are created
       with permissions of <em>-rw-rw----</em>. This allows normal users to list messages
       files but not read them.
       <p class="p-break"></p>
       The <em>emailrelay-submit</em> program is given group ownership of <em>daemon</em> with its
       group set-user-id flag set. This allows it to create message files in the
       spool directory, and the files created end up owned by the submitter but with
       group ownership of <em>daemon</em>.
      </dd>
     <dt>Logging</dt>
      <dd>
       Logging output is conditioned so that ANSI escape sequences cannot appear
       in the log.
       <p class="p-break"></p>
       Passwords and message content are not logged (except if using the <em>--debug</em>
       option at run time with debug logging enabled at build time).
      </dd>
     <dt>Information leakage</dt>
      <dd>
       The <em>--anonymous</em> option can be used to reduce the amount of information
       leaked to remote clients.
      </dd>
     <dt>Mandatory encryption</dt>
      <dd>
       When using PAM for authentication all clients are required to use
       TLS/SSL encryption.
      </dd>
    </dl>
    <p>
     Security issues which relate to the SMTP protocol itself are beyond the scope
     of this document, but RFC-2821 makes the following observation: "SMTP mail is
     inherently insecure in that it is feasible for even [..] casual users to [..]
     create messages that will trick a [..] recipient into believing that they came
     from somewhere else. [..] Real [..] security lies [..] in end-to-end methods
     [..] such as those which use digital signatures."
    </p>

    <p>
     The <em>Authentication</em>, <em>PAM Authentication</em> and <em>TLS encryption</em> sections
     above also relate to security.
    </p>
   <h2><a class="a-header" name="SH_1_14">Administration interface</a></h2> <!-- index:2:SH:1:14:Administration interface -->
    <p>
     If enabled with the <em>--admin</em> command-line option, the E-MailRelay server will
     provide a network interface for performing administration tasks. This is a
     simple command-line interface which is compatible with <em>netcat</em> and <em>telnet</em>:
    </p>

      <div class="div-pre">
       <pre>$ emailrelay --as-server --port=125 --forward-to=localhost:25 --admin=10026
$ telnet localhost 10026
E-MailRelay&gt; help
E-MailRelay&gt; quit
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>forward</em> command is used to trigger the E-MailRelay server into forwarding
     spooled mail to the next SMTP server.
    </p>

    <p>
     The <em>flush</em> command is similar but it uses its own connection to the SMTP
     server and waits for the messages to be sent.
    </p>

    <p>
     The <em>unfail-all</em> command can be used to remove the <em>.bad</em> filename extension
     from files in the spool directory.
    </p>

    <p>
     The <em>list</em> command lists the messages in the spool directory, <em>status</em> provides
     network status information and activity statistics, and <em>notify</em> enables
     asynchronous event notification.
    </p>
   <h2><a class="a-header" name="SH_1_15">Bcc handling</a></h2> <!-- index:2:SH:1:15:Bcc handling -->
    <p>
     E-MailRelay transfers e-mail messages without changing their content in any
     way, other than by adding a <em>Received</em> header. In particular, if a message
     contains a <em>Bcc:</em> header when it is submitted to the E-MailRelay server it
     will have the same <em>Bcc:</em> header when forwarded.
    </p>

    <p>
     It is normally the responsibility of the program that submits an e-mail
     message to submit it separately for each <em>Bcc</em> recipient, removing the <em>Bcc:</em>
     header from the message content or changing it to contain only the 'current'
     recipient. If this is not done, perhaps through mis-configuration of the
     e-mail user agent program, then <em>Bcc</em> recipients may be visible to the <em>To</em>
     and <em>Cc</em> message recipients.
    </p>

    <p>
     An E-MailRelay <em>--filter</em> script can be used to reject messages with incorrect
     <em>Bcc:</em> headers, and an example script is included.
    </p>
   <h2><a class="a-header" name="SH_1_16">Files and directories</a></h2> <!-- index:2:SH:1:16:Files and directories -->
    <p>
     On Unix-like systems E-MailRelay installs by default under <em>/usr/local</em>, but
     binary distributions will probably have been built to install elsewhere.
    </p>

    <p>
     Installation directories can be defined at build-time by the following
     <em>configure</em> script command-line options:
    </p>
    <ul>
     <li>--mandir=&lt;dir&gt;</li>
     <li>--sbindir=&lt;dir&gt;</li>
     <li>--localedir=&lt;dir&gt;</li>
     <li>e_bsdinitdir=&lt;dir&gt;</li>
     <li>e_docdir=&lt;dir&gt;</li>
     <li>e_examplesdir=&lt;dir&gt;</li>
     <li>e_icondir=&lt;dir&gt;</li>
     <li>e_trdir=&lt;dir&gt;</li>
     <li>e_initdir=&lt;dir&gt;</li>
     <li>e_libexecdir=&lt;dir&gt;</li>
     <li>e_pamdir=&lt;dir&gt;</li>
     <li>e_spooldir=&lt;dir&gt;</li>
     <li>e_sysconfdir=&lt;dir&gt;</li>
     <li>e_rundir=&lt;dir&gt;</li>
     <li>e_systemddir=&lt;dir&gt;</li>
    </ul>

    <p>
     These are all defaulted to paths that are ultimately based on <em>--prefix</em>, so
     <em>./configure --prefix=$HOME</em> will work as expected.
    </p>

    <p>
     For a directory structure conforming more closely to the File Hierarchy
     Standard (FHS) use this configure command:
    </p>

      <div class="div-pre">
       <pre>./configure --prefix=/usr --localstatedir=/var --libexecdir=/usr/lib --sysconfdir=/etc e_initdir=/etc/init.d e_rundir=/run/emailrelay
</pre>
      </div><!-- div-pre -->
    <p>
     It is possible to change the installation root directory after building by
     using <em>make DESTDIR=<root> install</em> or <em>DESTDIR=<root> make -e install</em>.
     However, this will not change the default spool directory path built into the
     scripts and executables so the correct spool directory will then have to be
     specified at run-time with the <em>--spool-dir</em> command-line option.
    </p>

    <p>
     On Windows the installation GUI prompts for two installation directories,
     and these default to <em>%ProgramFiles%/E-MailRelay</em> for programs and
     <em>%ProgramData%/E-MailRelay</em> for data.
    </p>



    <div class="div-footer">
     <p>
      Copyright (C) 2001-2022 Graeme Walker
     </p>
    </div><!-- div-footer -->
 </div> <!-- div-main -->
 </body>
</html>
<!-- Copyright (C) 2001-2022 Graeme Walker <graeme_walker@users.sourceforge.net>. All rights reserved. -->
