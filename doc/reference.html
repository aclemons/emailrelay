<!DOCTYPE html>
<html>
 <head>
  <title>E-MailRelay Reference</title>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <link rel="stylesheet" href="emailrelay.css" type="text/css">
 </head>
 <body>
  <!-- index:0::::E-MailRelay Reference -->
 <div class="div-main">
  <h1><a class="a-header" name="H_1">E-MailRelay Reference</a></h1> <!-- index:1:H:E-MailRelay Reference -->
   <h2><a class="a-header" name="SH_1_1">Command line usage</a></h2> <!-- index:2:SH:1:1:Command line usage -->
    <p>
     The <em>emailrelay</em> program supports the following command-line usage:
    </p>

      <div class="div-pre">
       <pre>emailrelay [&lt;option&gt; [&lt;option&gt; ...]] [&lt;config-file&gt;]</pre>
      </div><!-- div-pre -->
   <h3><a class="a-header">Basic options</a></h3>
    <dl>
     <dt>--as-client &lt;host:port&gt; (-q)</dt>
      <dd>
       This is equivalent to <em>--log</em>, <em>--no-syslog</em>, <em>--no-daemon</em>, <em>--dont-serve</em>,
       <em>--forward</em> and <em>--forward-to</em>. It is a convenient way of running a
       forwarding agent that forwards spooled mail messages and then terminates.
      </dd>
     <dt>--as-proxy &lt;host:port&gt; (-y)</dt>
      <dd>
       This is equivalent to <em>--log</em>, <em>--close-stderr</em>, <em>--forward-on-disconnect</em>
       and <em>--forward-to</em>. It is a convenient way of running a store-and-forward
       daemon. Use <em>--log</em>, <em>--forward-on-disconnect</em> and <em>--forward-to</em> instead
       of <em>--as-proxy</em> to keep the standard error stream open.
      </dd>
     <dt>--as-server (-d)</dt>
      <dd>
       This is equivalent to <em>--log</em> and <em>--close-stderr</em>. It is a convenient way of
       running a background storage daemon that accepts mail messages and spools
       them. Use <em>--log</em> instead of <em>--as-server</em> to keep standard error stream
       open.
      </dd>
     <dt>--spool-dir &lt;dir&gt; (-s)</dt>
      <dd>
       Specifies the directory used for holding mail messages that have been
       received but not yet forwarded.
      </dd>
     <dt>--help (-h)</dt>
      <dd>
       Displays help text and then exits. Use with <em>--verbose</em> for more complete
       output.
      </dd>
     <dt>--version (-V)</dt>
      <dd>
       Displays version information and then exits.
      </dd>
    </dl>
   <h3><a class="a-header">SMTP client options</a></h3>
    <dl>
     <dt>--client-smtp-config &lt;config&gt; (-c)</dt>
      <dd>
       Configures the SMTP client protocol using a comma-separated list of optional
       features, including 'pipelining', 'smtputf8strict', 'eightbitstrict' and
       'binarymimestrict'.
      </dd>
     <dt>--forward (-f)</dt>
      <dd>
       Causes spooled mail messages to be forwarded when the program first starts.
      </dd>
     <dt>--forward-on-disconnect (-1)</dt>
      <dd>
       Causes spooled mail messages to be forwarded whenever a SMTP client
       connection disconnects.
      </dd>
     <dt>--forward-to &lt;host:port&gt; (-o)</dt>
      <dd>
       Specifies the transport address of the remote SMTP server that spooled mail
       messages are forwarded to.
      </dd>
     <dt>--poll &lt;period&gt; (-O)</dt>
      <dd>
       Causes forwarding of spooled mail messages to happen at regular intervals
       (with the time given in seconds).
      </dd>
     <dt>--client-filter &lt;program&gt; (-Y)</dt>
      <dd>
       Runs the specified external filter program whenever a mail message is
       forwarded. The filter is passed the name of the message file in the spool
       directory so that it can edit it as required. A network filter can be
       specified as <em>net:<tcp-address></em> and prefixes of <em>spam:</em>, <em>spam-edit:</em> and
       <em>exit:</em> are also allowed. The <em>spam:</em> and <em>spam-edit:</em> prefixes require a
       SpamAssassin daemon to be running. For store-and-forward applications the
       <em>--filter</em> option is normally more useful than <em>--client-filter</em>.
      </dd>
     <dt>--client-interface &lt;ip-address&gt; (-6)</dt>
      <dd>
       Specifies the IP network address to be used to bind the local end of outgoing
       SMTP connections. By default the address will depend on the routing tables
       in the normal way. Use <em>0.0.0.0</em> to use only IPv4 addresses returned from
       DNS lookups of the <em>--forward-to</em> address, or <em>::</em> for IPv6.
      </dd>
     <dt>--connection-timeout &lt;time&gt; (-U)</dt>
      <dd>
       Specifies a timeout (in seconds) for establishing a TCP connection to remote
       SMTP servers. The default is 40 seconds.
      </dd>
     <dt>--idle-timeout &lt;time&gt;</dt>
      <dd>
       Specifies a timeout (in seconds) for receiving network traffic from remote
       SMTP and POP clients. The default is 60 seconds.
      </dd>
     <dt>--response-timeout &lt;time&gt; (-T)</dt>
      <dd>
       Specifies a timeout (in seconds) for getting responses from remote SMTP
       servers. The default is 60 seconds.
      </dd>
     <dt>--forward-to-all</dt>
      <dd>
       Requires all recipient addresses to be accepted by the remote server before
       forwarding. This is currently the default behaviour  so this option is for
       forwards compatibility only.
      </dd>
     <dt>--forward-to-some</dt>
      <dd>
       Allow forwarding to continue even if some recipient addresses on an e-mail
       envelope are rejected by the remote server.
      </dd>
     <dt>--immediate (-m)</dt>
      <dd>
       Causes mail messages to be forwarded as they are received, even before they
       have been accepted. This can be used to do proxying without
       store-and-forward, but in practice clients tend to to time out while
       waiting for their mail message to be accepted.
      </dd>
    </dl>
   <h3><a class="a-header">SMTP server options</a></h3>
    <dl>
     <dt>--port &lt;port&gt; (-p)</dt>
      <dd>
       Sets the port number used for listening for incoming SMTP connections.
      </dd>
     <dt>--remote-clients (-r)</dt>
      <dd>
       Allows incoming connections from addresses that are not local. The default
       behaviour is to reject connections that are not local in order to prevent
       accidental exposure to the public internet, although a firewall should also
       be used. Local address ranges are defined in RFC-1918, RFC-6890 etc.
      </dd>
     <dt>--address-verifier &lt;program&gt;</dt>
      <dd>
       Runs the specified external program to verify a message recipient's e-mail
       address. A network verifier can be specified as <em>net:<tcp-address></em>. The
       <em>account:</em> built-in address verifier can be used to check recipient
       addresses against the list of local system account names.
      </dd>
     <dt>--anonymous[=&lt;scope&gt;] (-A)</dt>
      <dd>
       Disables the server's SMTP VRFY command, sends less verbose SMTP greeting and
       responses, stops <em>Received</em> lines being added to mail message content
       files, and stops the SMTP client protocol adding <em>AUTH=</em> to the <em>MAIL</em>
       command. For finer control use a comma-separated list of things to
       anonymise: <em>vrfy</em>, <em>server</em>, <em>content</em> and/or <em>client</em>, eg.
       <em>--anonymous=server</em>,content.
      </dd>
     <dt>--delivery-dir &lt;dir&gt; (-s)</dt>
      <dd>
       Specifies the base directory for mailboxes when delivering  messages that
       have local recipients. This defaults to the main spool directory.
      </dd>
     <dt>--dnsbl &lt;config&gt;</dt>
      <dd>
       Specifies a list of DNSBL servers that are used to reject SMTP connections
       from blocked addresses. The configuration string is made up of
       comma-separated fields: the DNS server's transport address, a timeout in
       milliseconds, a rejection threshold, and then the list of DNSBL servers.
      </dd>
     <dt>--domain &lt;fqdn&gt; (-D)</dt>
      <dd>
       Specifies the network name that is used in SMTP EHLO commands, <em>Received</em>
       lines, and for generating authentication challenges. The default is derived
       from a DNS lookup of the local hostname.
      </dd>
     <dt>--filter &lt;program&gt; (-z)</dt>
      <dd>
       Runs the specified external filter program whenever a mail message is stored.
       The filter is passed the name of the message file in the spool directory so
       that it can edit it as required. The mail message is rejected if the filter
       program terminates with an exit code between 1 and 99. Use
       <em>net:<tcp-address></em> to communicate with a filter daemon over the network,
       or <em>spam:<tcp-address></em> for a spamassassin spamd daemon to accept or reject
       mail messages, or <em>spam-edit:<tcp-address></em> to have spamassassin edit the
       message content without rejecting it, or <em>exit:<number></em> to emulate a
       filter program that just exits.
      </dd>
     <dt>--filter-timeout &lt;time&gt; (-W)</dt>
      <dd>
       Specifies a timeout (in seconds) for running a <em>--filter</em> program. The
       default is 60 seconds.
      </dd>
     <dt>--interface &lt;ip-address-list&gt; (-I)</dt>
      <dd>
       Specifies the IP network addresses or interface names used to bind listening
       ports. By default listening ports for incoming SMTP, POP and administration
       connections will bind the 'any' address for IPv4 and for IPv6, ie.
       <em>0.0.0.0</em> and <em>::</em>. Multiple addresses can be specified by using the option
       more than once or by using a comma-separated list. Use a prefix of <em>smtp=</em>,
       <em>pop=</em> or <em>admin=</em> on addresses that should apply only to those types of
       listening port. Any link-local IPv6 addresses must include a zone name or
       scope id.  Interface names can be used instead of addresses, in which case
       all the addresses associated with that interface at startup will used for
       listening. When an interface name is decorated with a <em>-ipv4</em> or <em>-ipv6</em>
       suffix only their IPv4 or IPv6 addresses will be used (eg. <em>ppp0-ipv4</em>).
       To inherit listening file descriptors from the parent process on unix use a
       syntax like this: <em>--interface</em> smtp=fd#3,smtp=fd#4,pop=fd#5.
      </dd>
     <dt>--prompt-timeout &lt;time&gt; (-w)</dt>
      <dd>
       Specifies a timeout (in seconds) for getting the initial prompt from a remote
       SMTP server. If no prompt is received after this time then the SMTP dialog
       goes ahead without it.
      </dd>
     <dt>--server-smtp-config &lt;config&gt; (-Z)</dt>
      <dd>
       Configures the SMTP server protocol using a comma-separated list of optional
       features, including 'pipelining', 'chunking', 'smtputf8', and
       'smtputf8strict'.
      </dd>
     <dt>--size &lt;bytes&gt; (-M)</dt>
      <dd>
       Limits the size of mail messages that can be submitted over SMTP.
      </dd>
    </dl>
   <h3><a class="a-header">POP server options</a></h3>
    <dl>
     <dt>--pop (-B)</dt>
      <dd>
       Enables the POP server, listening by default on port 110, providing access to
       spooled mail messages. Negotiated TLS using the POP <em>STLS</em> command will be
       enabled if the <em>--server-tls</em> option is also given.
      </dd>
     <dt>--pop-by-name (-J)</dt>
      <dd>
       Modifies the POP server's spool directory to be the sub-directory with the
       same name as the user-id used for POP authentication. This  allows POP
       clients to see only their own messages after they have  been moved into
       separate sub-directories typically by the built-in  <em>deliver:</em> or <em>copy:</em>
       filters. Content files can remain in the  main spool directory to save disk
       space; they will be deleted by  the POP server when it deletes the last
       matching envelope file.
      </dd>
     <dt>--pop-no-delete (-G)</dt>
      <dd>
       Disables the POP DELE command so that the command appears to succeed but mail
       messages are not deleted from the spool directory.
      </dd>
     <dt>--pop-port &lt;port&gt; (-E)</dt>
      <dd>
       Sets the POP server's listening port number.
      </dd>
    </dl>
   <h3><a class="a-header">Admin server options</a></h3>
    <dl>
     <dt>--admin &lt;port&gt; (-a)</dt>
      <dd>
       Enables an administration interface on the specified listening port number.
       Use telnet or something similar to connect. The administration interface
       can be used to trigger forwarding of spooled mail messages if the
       <em>--forward-to</em> option is used.
      </dd>
     <dt>--admin-terminate (-Q)</dt>
      <dd>
       Enables the <em>terminate</em> command in the administration interface.
      </dd>
    </dl>
   <h3><a class="a-header">Authentication options</a></h3>
    <dl>
     <dt>--client-auth &lt;file&gt; (-C)</dt>
      <dd>
       Enables SMTP client authentication with the remote server, using the client
       account details taken from the specified secrets file.  The secrets file
       should normally contain one line having between four and five
       space-separated fields. The first field must be <em>client</em>, the second field
       is the password type (<em>plain</em> or <em>md5</em>), the third is the xtext-encoded
       user-id and the fourth is the xtext-encoded password. Alternatively, the
       user-id and password fields can be Base64 encoded if the second field is
       <em>plain:b</em>. It is also possible to do without a secrets file and give the
       Base64 encoded user-id and  password directly on the command-line or in the
       configuration file formatted as <em>plain:<base64-user-id>:<base64-password></em>.
       Note that putting these account details on the command-line is not
       recommended because it will make the password easily visible to all users
       on the  local machine.
      </dd>
     <dt>--client-auth-config &lt;config&gt;</dt>
      <dd>
       Configures the SMTP client authentication module using a semicolon-separated
       list of configuration items. Each item is a single-character key, followed
       by a colon and then a comma-separated list. A 'm' character introduces an
       ordered list of preferred authentication mechanisms and an 'x' introduces a
       list of mechanisms to avoid. An 'a' list and a 'd' list can be used
       similarly to prefer and avoid certain mechanisms once the session is
       encrypted with TLS.
      </dd>
     <dt>--server-auth &lt;file&gt; (-S)</dt>
      <dd>
       Enables SMTP server authentication of remote SMTP clients. Account names and
       passwords are taken from the specified secrets file. The secrets file
       should contain lines that have four space-separated fields, starting with
       <em>server</em> in the first field; the second field is the password encoding
       (<em>plain</em> or <em>md5</em>), the third is the client user-id and the fourth is the
       password. The user-id is RFC-1891 xtext encoded, and the password is either
       xtext encoded or generated by <em>emailrelay-passwd</em>. Alternatively, the
       username and password can be Base64 encoded if the second field is
       <em>plain:b</em>. A special value of  <em>pam:</em> can be used for authentication using
       linux PAM.
      </dd>
     <dt>--server-auth-config &lt;config&gt;</dt>
      <dd>
       Configures the SMTP server authentication module using a semicolon-separated
       list of configuration items. Each item is a single-character key, followed
       by a colon and then a comma-separated list. A 'm' character introduces an
       ordered list of allowed authentication mechanisms and an 'x' introduces a
       list of mechanisms to deny. An 'a' list and a 'd' list can be used
       similarly to allow and deny mechanisms once the session is encrypted with
       TLS. In typical usage you might have an empty allow list for an unencrypted
       session and a single preferred mechanism once encrypted, <em>m:;a:plain</em>.
      </dd>
     <dt>--pop-auth &lt;file&gt; (-F)</dt>
      <dd>
       Specifies a file containing valid POP account details. The file format is the
       same as for the SMTP server secrets file, ie. lines starting with <em>server</em>,
       with user-id and password in the third and fourth fields. A special value
       of <em>pam:</em> can be used for authentication using linux PAM.
      </dd>
    </dl>
   <h3><a class="a-header">TLS options</a></h3>
    <dl>
     <dt>--client-tls (-j)</dt>
      <dd>
       Enables negotiated TLS for outgoing SMTP connections; the SMTP STARTTLS
       command will be issued if the remote server supports it.
      </dd>
     <dt>--client-tls-certificate &lt;pem-file&gt;</dt>
      <dd>
       Defines the TLS certificate file when acting as a SMTP client. This file must
       contain the client's private key and certificate chain using the PEM file
       format. Alternatively, use this option twice with the first one specifying
       the key file and the second the certificate file. Keep the file permissions
       tight to avoid accidental exposure of the private key.
      </dd>
     <dt>--client-tls-connection (-b)</dt>
      <dd>
       Enables the use of a TLS tunnel for outgoing SMTP connections. This is for
       SMTP over TLS (SMTPS), not TLS negotiated within SMTP using STARTTLS.
      </dd>
     <dt>--client-tls-required</dt>
      <dd>
       Makes the use of TLS mandatory for outgoing SMTP connections. The SMTP
       STARTTLS command will be used before mail messages are sent out. If the
       remote server does not allow STARTTLS then the SMTP connection will fail.
      </dd>
     <dt>--client-tls-server-name &lt;hostname&gt;</dt>
      <dd>
       Defines the target server hostname in the TLS handshake. With
       <em>--client-tls-connection</em> this can be used for SNI, allowing the remote
       server to adopt an appropriate identity.
      </dd>
     <dt>--client-tls-verify &lt;ca-list&gt;</dt>
      <dd>
       Enables verification of the remote SMTP server's certificate against any of
       the trusted CA certificates in the specified file or directory. In many use
       cases this should be a file containing just your self-signed root
       certificate. Specify <em><default></em> (including the angle brackets) for the TLS
       library's default set of trusted CAs.
      </dd>
     <dt>--client-tls-verify-name &lt;cname&gt;</dt>
      <dd>
       Enables verification of the CNAME within the remote SMTP server's
       certificate.
      </dd>
     <dt>--server-tls (-K)</dt>
      <dd>
       Enables TLS for incoming SMTP and POP connections. SMTP clients can then
       request TLS encryption by issuing the STARTTLS command. The
       <em>--server-tls-certificate</em> option must be used to define the server
       certificate.
      </dd>
     <dt>--server-tls-certificate &lt;pem-file&gt;</dt>
      <dd>
       Defines the TLS certificate file when acting as a SMTP or POP server. This
       file must contain the server's private key and certificate chain using the
       PEM file format. Alternatively, use this option twice with the first
       specifying the key file and the second the certificate  file. Keep the file
       permissions tight to avoid accidental exposure  of the private key.
      </dd>
     <dt>--server-tls-connection</dt>
      <dd>
       Enables SMTP over TLS when acting as an SMTP server. This is for SMTP over
       TLS (SMTPS), not TLS negotiated within SMTP using STARTTLS.
      </dd>
     <dt>--server-tls-required</dt>
      <dd>
       Makes the use of TLS mandatory for any incoming SMTP and POP connections.
       SMTP clients must use the STARTTLS command to establish a TLS session
       before they can issue SMTP AUTH or SMTP MAIL-TO commands.
      </dd>
     <dt>--server-tls-verify &lt;ca-list&gt;</dt>
      <dd>
       Enables verification of remote SMTP and POP clients' certificates against any
       of the trusted CA certificates in the specified file or directory. In many
       use cases this should be a file containing just your self-signed root
       certificate. Specify <em><default></em>  (including the angle brackets) for the
       TLS library's default set  of trusted CAs.
      </dd>
     <dt>--tls-config &lt;options&gt; (-9)</dt>
      <dd>
       Selects and configures the low-level TLS library, using a comma-separated
       list of keywords. If OpenSSL and mbedTLS are both built in then keywords of
       <em>openssl</em> and <em>mbedtls</em> will select one or the other. Keywords like
       <em>tlsv1.0</em> can be used to set a minimum TLS protocol version, or <em>-tlsv1.2</em>
       to set a maximum version.
      </dd>
    </dl>
   <h3><a class="a-header">Process options</a></h3>
    <dl>
     <dt>--dont-serve (-x)</dt>
      <dd>
       Disables all network serving, including SMTP, POP and administration
       interfaces. The program will terminate as soon as any initial forwarding is
       complete.
      </dd>
     <dt>--hidden (-H)</dt>
      <dd>
       Windows only. Hides the application window and disables all message boxes,
       overriding any <em>--show</em> option. This is useful when running as a windows
       service.
      </dd>
     <dt>--localedir &lt;dir&gt;</dt>
      <dd>
       Enables localisation and specifies the locale base directory where message
       catalogues can be found. An empty directory can be used for the built-in
       default.
      </dd>
     <dt>--no-daemon (-t)</dt>
      <dd>
       Disables the normal backgrounding at startup so that the program runs in the
       foreground, without forking or detaching from the terminal.  On Windows
       this disables the system tray icon so the program uses a normal window;
       when the window is closed the program terminates.
      </dd>
     <dt>--no-smtp (-X)</dt>
      <dd>
       Disables listening for incoming SMTP connections.
      </dd>
     <dt>--pid-file &lt;path&gt; (-i)</dt>
      <dd>
       Causes the process-id to be written into the specified file when the program
       starts up, typically after it has become a background daemon. The immediate
       parent directory is created if necessary.
      </dd>
     <dt>--user &lt;username&gt; (-u)</dt>
      <dd>
       When started as root the program switches to a non-privileged effective
       user-id when idle or when running external filter scripts and address
       verifiers. This option can be used to define the non-privileged user-id. It
       also determines the group ownership of new files and sockets if the
       directory owner is not 'sticky'. Specify <em>root</em> to disable all user-id
       switching. Ignored on Windows.
      </dd>
    </dl>
   <h3><a class="a-header">Logging options</a></h3>
    <dl>
     <dt>--verbose (-v)</dt>
      <dd>
       Enables more verbose logging when used with <em>--log</em>, and more verbose help
       when used with <em>--help</em>.
      </dd>
     <dt>--log (-l)</dt>
      <dd>
       Enables logging to the standard error stream and to the syslog. The
       <em>--close-stderr</em> and <em>--no-syslog</em> options can be used to disable output to
       standard error stream and the syslog separately. Note that <em>--as-server</em>,
       <em>--as-client</em> and <em>--as-proxy</em> imply <em>--log</em>, and <em>--as-server</em> and
       <em>--as-proxy</em> also imply <em>--close-stderr</em>.
      </dd>
     <dt>--debug (-g)</dt>
      <dd>
       Enables debug level logging, if built in. Debug messages are usually only
       useful when cross-referenced with the source code and they may expose
       plain-text passwords and mail message content.
      </dd>
     <dt>--log-address</dt>
      <dd>
       Adds the network address of remote clients to the logging output.
      </dd>
     <dt>--log-file &lt;file&gt; (-N)</dt>
      <dd>
       Redirects standard-error logging to the specified file. Logging to the log
       file is not affected by <em>--close-stderr</em>. The filename can include <em>%d</em> to
       get daily log files; the <em>%d</em> is replaced by the current date in the local
       timezone using a <em>YYYYMMDD</em> format.
      </dd>
     <dt>--log-time (-L)</dt>
      <dd>
       Adds a timestamp to the logging output using the local timezone.
      </dd>
     <dt>--no-syslog (-n)</dt>
      <dd>
       Disables logging to the syslog. Note that <em>--as-client</em> implies
       <em>--no-syslog</em>.
      </dd>
     <dt>--syslog[=&lt;facility&gt;] (-k)</dt>
      <dd>
       When used with <em>--log</em> this option enables logging to the syslog even if the
       <em>--no-syslog</em> option is also used. This is typically used as a convenient
       override when using <em>--as-client</em>.
      </dd>
     <dt>--close-stderr (-e)</dt>
      <dd>
       Causes the standard error stream to be closed soon after start-up. This is
       useful when operating as a background daemon and it is therefore implied by
       <em>--as-server</em> and <em>--as-proxy</em>.
      </dd>
    </dl>
   <h2><a class="a-header" name="SH_1_2">Configuration</a></h2> <!-- index:2:SH:1:2:Configuration -->
    <p>
     E-MailRelay is configured with command-line options and/or a configuration file.
     The configuration filename is given as the last command-line parameter.
    </p>

    <p>
     A configuration file should contain command-line options without double dashes,
     with each option on a separate line. The option name and the option value should
     be separated with a space. For example:
    </p>

      <div class="div-pre">
       <pre># emailrelay.conf
log
#verbose # commented out
spool-dir /tmp/spool
port 10025
</pre>
      </div><!-- div-pre -->
    <p>
     All options that specify a filename can use a special <em>@app</em> substitution
     variable that is interpreted as the directory that contains the <em>emailrelay</em>
     executable or MacOS application bundle.
    </p>

    <p>
     It is possible to run multiple E-MailRelay instances in one process by prefixing
     the <em>--spool-dir</em> option with an arbitrary name like <em>in</em> or <em>out</em>, ie.
     <em>--in-spool-dir</em> and <em>--out-spool-dir</em>. Subsequent options like <em>--in-port</em> and
     <em>--out-port</em> will then apply to the <em>in</em> and <em>out</em> instances separately. Any
     options without a prefix will apply to the first instance and process-wide
     options, including <em>--log</em>, <em>--verbose</em> <em>--no-daemon</em> and <em>--user</em>, will only
     take effect if unprefixed or prefixed by the first instance name. For example:
    </p>

      <div class="div-pre">
       <pre># emailrelay.conf
log
user root
# in...
in-spool-dir /var/spool/in
in-port 25
in-remote-clients
in-filter account:
in-domain example.com
# out...
out-spool-dir /var/spool/out
out-port 587
out-forward-on-disconnect
out-forward-to smtp.smarthost.com</pre>
      </div><!-- div-pre -->
   <h2><a class="a-header" name="SH_1_3">Message store</a></h2> <!-- index:2:SH:1:3:Message store -->
    <p>
     E-mail messages are stored as text files in the configured spool directory; each
     message is represented as an envelope file and a content file. The envelope file
     contains parameters relevant to the SMTP dialogue, and the content file contains
     the RFC-822 headers and body text.
    </p>

    <p>
     Envelope files can be modified by external filter scripts as long as the basic
     structure is retained, and some E-MailRelay features such as routing and client
     account selection can only be accessed in this way.
    </p>

    <p>
     The filenames used in the message store have a prefix of <em>emailrelay</em>, followed
     by a process-id, timestamp and sequence number, and then <em>envelope</em> or
     <em>content</em>. The envelope files then have an additional suffix to implement a
     simple locking scheme.
    </p>

    <p>
     The envelope file suffixes are:
    </p>

    <ul>
     <li><em>.new</em> -- while the e-mail message is first being written</li>
     <li><em>.busy</em> -- while the message is being forwarded</li>
     <li><em>.bad</em> -- if the message cannot be forwarded</li>
    </ul>

    <p>
     If an e-mail message cannot be forwarded the envelope file is given a <em>.bad</em>
     suffix, and the failure reason is written into the file.
    </p>

    <p>
     Sub-directories of the main spool directory are sometimes used as mailboxes
     containing e-mail messages that have been delivered to local e-mail recipients.
    </p>
   <h2><a class="a-header" name="SH_1_4">Forwarding</a></h2> <!-- index:2:SH:1:4:Forwarding -->
    <p>
     Spooled e-mail messages can be forwarded at various times, depending on the
     command-line options:
    </p>

    <ul>
     <li>when E-MailRelay first starts up (<em>--as-client</em> or <em>--forward</em>)</li>
     <li>as each message is submitted, just before receipt is acknowledged (<em>--immediate</em>)</li>
     <li>as soon as the submitting client disconnects (<em>--forward-on-disconnect</em>)</li>
     <li>periodically (<em>--poll=<seconds></em>)</li>
     <li>on demand using the administration interface's <em>forward</em> command (<em>--admin=<port></em>)</li>
     <li>when a <em>--filter</em> script exits with an exit code of 103</li>
    </ul>

    <p>
     These can be mixed.
    </p>

    <p>
     When using <em>--as-client</em>, or <em>--dont-serve</em> with <em>--forward</em>, the spooled
     messages begin to be forwarded as soon as the program starts up, and the
     program terminates once they have all been sent.
    </p>

    <p>
     Normally when an e-mail message is forwarded all the remote recipient e-mail
     addresses must be accepted by the remote server (<em>--forward-to-all</em>). If any one
     recipient is rejected then the message will be failed and left in the spool
     directory with a <em>.bad</em> suffix on the envelope file.
    </p>

    <p>
     However, if the <em>--forward-to-some</em> option is used then forwarding will succeed
     for the valid recipients and the failed message will contain just the invalid
     ones. (Future E-MailRelay releases might switch to <em>--forward-to-some</em> as the
     default, so use <em>--forward-to-all</em> if that is what is required.)
    </p>

    <p>
     If an address verifier has previously determined that all the recipient
     addresses in an e-mail message are local then it will be failed immediately when
     forwarding, before any interaction with the remote server.
    </p>
   <h2><a class="a-header" name="SH_1_5">Filters</a></h2> <!-- index:2:SH:1:5:Filters -->
    <p>
     The <em>--filter</em> command-line option can be used to specify a program or script
     that operates on e-mail messages as they pass through the E-MailRelay system.
     The filter program is run as soon as the e-mail message has been stored in the
     spool directory, with the full path of the content file and envelope file put
     on the command-line.
    </p>

    <p>
     For example, the following command will start E-MailRelay as a proxy server
     on port 587 that processes mail using the specified filter program, and then
     forwards it on to the local system's default MTA on port 25:
    </p>

      <div class="div-pre">
       <pre>emailrelay --as-proxy=127.0.0.1:25 --port=587 --filter=@app/myfilter --spool-dir=@app/spool
</pre>
      </div><!-- div-pre -->
    <p>
     The filter program should terminate with an exit code of zero to indicate
     success, or a value between 1 and 99 to indicate failure.
    </p>

    <p>
     When the filter program terminates with a non-zero exit code the envelope file
     is given a <em>.bad</em> filename suffix so that it will not get picked up for
     forwarding and the first few thousand characters of the filter's standard output
     stream are searched for a line like <em><<error text>></em> or <em>[[error text]]</em>. The
     error text inside the double square or angle brackets is taken as a failure
     reason and passed back to the remote SMTP client and also written into the
     envelope file. If the error text starts with a three-digit number between 400
     and 599 followed by a space then that is used as the SMTP response code. A
     second error-text line can be used for additional diagnostics that will not be
     visible to the client.
    </p>

    <p>
     Filter exit codes between 100 and 115 are reserved for special processing: 100
     is used to abandon the current e-mail message so the filter can safely delete
     the message files, and 103 has the effect of requesting a rescan of the spool
     directory if forwarding is enabled, typically to pick up on new messages that
     the filter program has created.
    </p>

    <p>
     The filter program can edit any part of the e-mail message's envelope file or
     content file: E-MailRelay remembers nothing about the e-mail message while the
     filter is running except the filename. However, if the message is deleted by
     the filter program then it should use an exit code of 100 to avoid spurious
     warning messages.
    </p>

    <p>
     As an example of a simple filter program processor this shell script examines
     the message envelope and deletes the e-mail message if it has come from a
     particular IP address:
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# filter.sh
content="$1"
envelope="$2"
ip="`sed -n -e '/MailRelay-Client:/{p;q}' \"$envelope\"`"
if test "$ip" = "192.168.0.2"
then
    rm -f "$envelope" "$content"
    exit 100 # &lt;= cancel further processing
fi
exit 0
</pre>
      </div><!-- div-pre -->
    <p>
     For Windows this example can be rewritten in JavaScript:
    </p>

      <div class="div-pre">
       <pre>// filter.js
var content = WScript.Arguments(0) ;
var envelope = WScript.Arguments(1) ;
var fs = WScript.CreateObject( "Scripting.FileSystemObject" ) ;
var ts = fs.OpenTextFile( envelope , 1 , false ) ;
var e = ts.ReadAll() ;
ts.Close() ;
var re = new RegExp( "MailRelay-Client: \(.*\)" ) ;
var ip = e.match(re)[1] ;
if( ip === "192.168.0.2" )
{
    fs.DeleteFile( content ) ;
    fs.DeleteFile( envelope ) ;
    WScript.Quit( 100 )
}
WScript.Quit( 0 ) ;
</pre>
      </div><!-- div-pre -->
    <p>
     Windows filter programs written in JavaScript can be run with an E-MailRelay
     <em>--filter</em> option something like this:
    </p>

      <div class="div-pre">
       <pre>--filter="C:/Program Files/E-MailRelay/filter.js"
</pre>
      </div><!-- div-pre -->
    <p>
     Note that double-quotes are needed because the file path contains a space.
     Either forward-slashes or back-slashes can be used.
    </p>

    <p>
     E-MailRelay also has a <em>--client-filter</em> option that enables processing of
     e-mail messages just before they are forwarded, rather than after they are
     stored. The disadvantage is that by then it is too late to notify the submitting
     SMTP client of any processing failures so in many store-and-forward applications
     using <em>--filter</em> is more useful. The special exit code of 100 can be used to
     ignore the current message, and 102 to stop scanning for more spooled messages
     after processing the current one (eg. for simple rate-limiting).
    </p>

    <p>
     Bear in mind the following points when writing <em>--filter</em> programs:
    </p>

    <ul>
     <li>The standard input and output are not used for message content; the message filenames are passed on the command-line.</li>
     <li>Programs are run with a reduced set of environment variables.</li>
     <li>Message files use CR-LF line terminators.</li>
     <li>Envelope files will have a file extension of <em>.new</em> or <em>.busy</em> when the filter runs.</li>
     <li>Content files on Linux/Unix might be hard-linked if using <em>--filter=split:</em>.</li>
     <li>On Linux/Unix the filter runs as an unprivileged user unless using <em>--user=root</em>.</li>
    </ul>
   <h2><a class="a-header" name="SH_1_6">Network filters</a></h2> <!-- index:2:SH:1:6:Network filters -->
    <p>
     E-MailRelay filters are normally external programs or scripts that operate on
     the message files in the spool directory, but filters can also be network
     servers.
    </p>
   <h3><a class="a-header">net:</a></h3>
    <p>
     To use a network server as a filter the <em>--filter</em> or <em>--client-filter</em> option
     should start with <em>net:</em> followed by the address of the server:
    </p>

      <div class="div-pre">
       <pre>--filter=net:localhost:10101
</pre>
      </div><!-- div-pre -->
    <p>
     E-MailRelay connects to this address and then uses a simple line-based dialog
     as each e-mail message is processed: it sends the full path of the message
     content file in one line and expects the remote process to respond with an <em>ok</em>
     line if the message is to be accepted or an error message. If the error message
     contains a tab character then anything after the tab character is logged but
     otherwise ignored.
    </p>

    <p>
     E-MailRelay is responsible for maintaining the connection to the <em>net:</em> server
     so the server should not normally disconnect after responding.
    </p>
   <h3><a class="a-header">spam:</a></h3>
    <p>
     It is also possible to use a SpamAssassin <em>spamd</em> server as an E-MailRelay
     network filter by using <em>spam:</em> or <em>spam-edit:</em> instead of <em>net:</em>.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--filter=spam-edit:127.0.0.1:783
</pre>
      </div><!-- div-pre -->
    <p>
     Using <em>spam:</em> means that the e-mail message will be rejected outright if it
     fails the SpamAssassin tests, whereas with <em>spam-edit:</em> the message content is
     edited by SpamAssassin to hide the original content within an attachment.
    </p>
   <h2><a class="a-header" name="SH_1_7">Built-in filters</a></h2> <!-- index:2:SH:1:7:Built-in filters -->
    <p>
     E-MailRelay has a few built-in filters.
    </p>
   <h3><a class="a-header">exit:</a></h3>
    <p>
     The simplest is the <em>exit:</em> filter that simulates a filter program that exits
     immediately with a specific exit code:
    </p>

      <div class="div-pre">
       <pre>--filter=exit:103
</pre>
      </div><!-- div-pre -->
    <p>
     This is useful for the special exit codes, such as exit code 103 which requests
     a rescan of the spool directory for forwarding.
    </p>
   <h3><a class="a-header">copy:</a></h3>
    <p>
     The <em>copy:</em> filter copies the e-mail message's envelope and content files into
     all the sub-directories of the main spool directory and then deletes the
     original:
    </p>

      <div class="div-pre">
       <pre>--filter=copy:
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>copy:</em> filter will not copy into a <em>postmaster</em> sub-directory or into any
     sub-directory with a name starting with a dot.
    </p>

    <p>
     If any destination directories have <em>new</em>, <em>tmp</em> and <em>cur</em> sub-directories then
     they are treated as <em>maildir</em> mailboxes.
    </p>

    <p>
     To save disk space the content files can be hard-linked by using <em>copy:hardlink</em>
     (Linux/Unix only) or they can stay in the main spool directory by using
     <em>copy:pop</em>. The <em>copy:pop</em> option is normally used with <em>--pop-by-name</em>:
    </p>

      <div class="div-pre">
       <pre>--filter=copy:pop --pop --pop-by-name --pop-auth=...</pre>
      </div><!-- div-pre -->
   <h3><a class="a-header">deliver:</a></h3>
    <p>
     The <em>deliver:</em> filter is used to deliver copies of incoming e-mail messages into
     a separate mailbox directory for each message recipient where the address
     verifier has supplied a local mailbox name:
    </p>

      <div class="div-pre">
       <pre>--filter=deliver:
</pre>
      </div><!-- div-pre -->
    <p>
     If the message has no local recipients then the filter does nothing. If it has
     only local recipients then it will be deleted once it has been copied into
     mailboxes.
    </p>

    <p>
     The delivery base directory defaults to the main spool directory but it can be
     overridden with the <em>--delivery-dir</em> option:
    </p>

      <div class="div-pre">
       <pre>--filter=deliver: --delivery-dir=@app/mailboxes --spool-dir=@app/spool
</pre>
      </div><!-- div-pre -->
    <p>
     Optional semi-colon separated parameters can be used to modify its behaviour:
    </p>

      <div class="div-pre">
       <pre>--filter="deliver:hardlink;no_delete"
</pre>
      </div><!-- div-pre -->
    <p>
     See <em>Delivery</em> below for more details.
    </p>
   <h3><a class="a-header">split:</a></h3>
    <p>
     The <em>split:</em> filter can be used when outgoing e-mail messages need to be routed
     to different next-hop servers according to the recipient addresses. The filter
     examines the domain part of the recipient addresses in the SMTP envelope file
     and if there is more than one domain then the message is copied so that each
     copy relates to a single domain. It then copies the recipient address's domain
     name into the <em>ForwardTo</em> field within the envelope file.
    </p>

    <p>
     Note that if new messages are created by the <em>split:</em> filter then they will not
     be processed by any other server-side filters.
    </p>

    <p>
     Domain name comparisons are case-insensitive by default. For exact comparisons
     use <em>split:raw</em>. This might be useful if an address verifier has already
     sanitised the recipient addresses.
    </p>

    <p>
     On Linux/Unix the content file copies will be hard links where possible.
    </p>
   <h3><a class="a-header">mx:</a></h3>
    <p>
     The <em>mx:</em> filter performs a DNS MX lookup on any <em>ForwardTo</em> domain given in
     the envelope file and stores the resulting IP address in the
     <em>ForwardToAddress</em> field. The <em>ForwardTo</em> field can optionally have a colon
     separated numeric port number.
    </p>

    <p>
     The <em>mx:</em> filter should normally be run as a client filter (<em>--client-filter</em>)
     so that the IP address is up-to-date when the forwarding connection is made.
    </p>

    <p>
     The <em>split:</em> and <em>mx:</em> filters work together to implement message routing:
    </p>

      <div class="div-pre">
       <pre>--filter=split: --client-filter=mx:
</pre>
      </div><!-- div-pre -->
    <p>
     By running as a client filter the <em>mx:</em> filter will pick up any new messages
     created by <em>split:</em>.
    </p>

    <p>
     The filter can be configured with optional address for the DNS server after
     the <em>mx:</em> string:
    </p>

      <div class="div-pre">
       <pre>--client-filter="mx:127.0.0.1:53"
</pre>
      </div><!-- div-pre -->
    <p>
     If the DNS server responds with a forwarding address of <em>0.0.0.0</em> then the
     <em>ForwardToAddress</em> will be cleared and the message will be forwarded to the
     default <em>--forward-to</em> address.
    </p>

    <p>
     See <em>Routing</em> below for more details.
    </p>
   <h3><a class="a-header">msgid:</a></h3>
    <p>
     The <em>msgid:</em> filter adds a RFC-822 <em>Message-ID</em> header to the content file if it
     does not have one already.
    </p>
   <h2><a class="a-header" name="SH_1_8">Address verifiers</a></h2> <!-- index:2:SH:1:8:Address verifiers -->
    <p>
     By default the E-MailRelay server will accept all recipient addresses for
     incoming e-mails as valid. This default behaviour can be modified by using an
     external verifier program, specified with the <em>--address-verifier</em> command-line
     option, so the verifier can choose which recipient addresses are accepted as
     valid and which are rejected.
    </p>

    <p>
     Address verifiers can also be used to identify recipient addresses that are
     local addresses with an associated mailbox.
    </p>

    <p>
     The verifier program is passed a command-line containing: (1) the recipient
     e-mail address as supplied by the remote client, (2) the <em>from</em> e-mail address
     as supplied by the client, or the empty string in the case of the <em>VRFY</em>
     command, (3) the IP address and port of the far end of the client
     connection, (4) the local fully qualified domain name, (5) the authentication
     mechanism used by the client (if any, and <em>none</em> if trusted), and (6) either
     the authentication name or the fourth field from authentication secrets file
     if a trusted IP address.
    </p>

    <p>
     So, for example, a verifier program called <em>myverifier</em> might be run as if with
     the following command-line:
    </p>

      <div class="div-pre">
       <pre>myverifier bob@local.net alice@example.com 192.168.0.1:123 local.net login alice
</pre>
      </div><!-- div-pre -->
    <p>
     The verifier program should generate two lines of output on the standard output
     stream and then terminate with a specific exit code.
    </p>

    <p>
     For valid addresses the first line of output is ignored, the second line should
     normally be copied from the first command-line argument, and the exit value
     should be one.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- accept all (252)
echo ""
echo "$1"
exit 1
</pre>
      </div><!-- div-pre -->
    <p>
     The address verifier can also modify a recipient address, for example by
     converting to lower-case:
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- accept all and normalise (252)
echo ""
echo "$1" | tr '[A-Z]' '[a-z]'
exit 1
</pre>
      </div><!-- div-pre -->
    <p>
     The modified recipient address is stored in the envelope file and will be used
     as the SMTP RCPT-TO address when the message is forwarded.
    </p>

    <p>
     If the address verifier identifies a recipient address as being a local user
     with an associated mailbox then it should write two lines to the standard
     output -- the full name associated with the mailbox (only used in the response
     to the VRFY command), and the mailbox name used for message delivery -- and then
     exit with a value of zero.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- accept as local (250)
echo Local Postmaster '&lt;postmaster@localhost&gt;'
echo postmaster
exit 0
</pre>
      </div><!-- div-pre -->
    <p>
     Messages with recipient addresses that have been identified as local can be
     delivered to the relevant mailbox by a filter such as the built-in <em>deliver:</em>
     filter. Local recipient addresses are ignored when a message is forwarded by the
     SMTP client.
    </p>

    <p>
     For invalid addresses the verifier's exit value should be non-zero and the first
     line of output will be taken as the error response sent to the remote client. An
     optional second output line can be used for diagnostic information that gets
     recorded in the E-MailRelay log file.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- reject as invalid (550)
echo invalid mailbox: $1
exit 2
</pre>
      </div><!-- div-pre -->
    <p>
     To indicate a temporary failure this can be changed to an exit code of 3.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- reject as temporarily invalid (450)
echo mailbox unavailable: $1
exit 3
</pre>
      </div><!-- div-pre -->
    <p>
     If the verifier exit code is 100 then the connection is aborted immediately,
     which may be useful in limiting the impact of denial of service attacks.
    </p>

      <div class="div-pre">
       <pre>#!/bin/sh
# address verifier -- abort
exit 100
</pre>
      </div><!-- div-pre -->
    <p>
     Any other exit code, from 4 to 99 or 101 and above, behaves in the same way
     as an exit code of 2.
    </p>

    <p>
     On Windows address verifier scripts can be written in JavaScript, something
     like this:
    </p>

      <div class="div-pre">
       <pre>// verifier.js
try
{
    var address = WScript.Arguments(0) ;
    var user = address.split(/@/)[0] || "" ;
    var domain = address.split(/@/)[1] || "" ;
	if( user === "postmaster" )
	{
    	WScript.Stdout.WriteLine( "Postmaster &lt;postmaster@example.com&gt;" ) ;
    	WScript.Stdout.WriteLine( "postmaster" ) ;
        WScript.Quit( 0 ) ; // accept for delivery to mailbox "postmaster"
	}
	else if( domain !== "example.com" )
	{
    	WScript.Stdout.WriteLine( "invalid domain" ) ;
        WScript.Quit( 2 ) ; // reject (550)
	}
	else
	{
    	WScript.Stdout.WriteLine( "" ) ;
    	WScript.Stdout.WriteLine( address ) ;
    	WScript.Quit( 1 ) ; // accept
	}
}
catch( e )
{
    WScript.Stdout.WriteLine( "mailbox unavailable" ) ;
    WScript.Stdout.WriteLine( e ) ;
    WScript.Quit( 3 ) ;
}</pre>
      </div><!-- div-pre -->
   <h2><a class="a-header" name="SH_1_9">Address verifier servers</a></h2> <!-- index:2:SH:1:9:Address verifier servers -->
    <p>
     E-MailRelay address verifiers are normally external programs or scripts but it
     is also possible to do address verification in a separate network server if
     the <em>--address-verifier</em> option starts with <em>net:</em> followed by the network
     address and port number.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--address-verifier=net:127.0.0.1:10101
</pre>
      </div><!-- div-pre -->
    <p>
     In this case E-MailRelay will connect to the specified verifier daemon over the
     network and send address verification requests as lines with pipe-delimited
     fields. The expected response is another pipe-delimited line containing the same
     information as returned by verifier scripts but in reverse, such as
     <em>0|postmaster|Local Postmaster <postmaster@example.com></em> or
     <em>2|mailbox unavailable</em>.
    </p>

    <p>
     E-MailRelay is responsible for maintaining the connection to the <em>net:</em> server
     so the server should not normally disconnect after responding.
    </p>
   <h2><a class="a-header" name="SH_1_10">Built-in address verifiers</a></h2> <!-- index:2:SH:1:10:Built-in address verifiers -->
    <p>
     There is one built-in address verifier called <em>account:</em>.
    </p>
   <h3><a class="a-header">account:</a></h3>
    <p>
     The <em>account:</em> verifier does validation of recipient address against system
     account names and the network domain or <em>--domain</em> value. For example, it will
     accept <em>alice@example.com</em> only if there is a local system account called
     <em>alice</em> and the local fully-qualified domain name is <em>example.com</em>.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--address-verifier=account: --domain=example.com
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>account:</em> verifier can have one or more semi-colon separated configuration
     parameters following the verifier name, including a user-id range (defaulting to
     1000-32767) that is used to obtain the list of system account names and
     <em>lowercase</em> to convert upper-case 7-bit characters in the system account name to
     lower-case, <em>check</em> and <em>remote</em>.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--address-verifier="account:1000-1002;lowercase" --domain=example.com
</pre>
      </div><!-- div-pre -->
    <p>
     With the <em>check</em> parameter the verifier will test whether the recipient address
     is a local account but always accept the address as valid, whether it is a local
     account or not. This is useful for outgoing traffic where local recipients can be
     delivered immediately without being sent to the next-hop SMTP server.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--address-verifier=account:check --domain=example.com --delivery-dir=@app/in
</pre>
      </div><!-- div-pre -->
    <p>
     With the <em>remote</em> parameter the recipient address is valid only if it is a local
     account but it is treated as not local so that the e-mail message will be
     available for forwarding rather than delivery.
    </p>
   <h2><a class="a-header" name="SH_1_11">Authentication</a></h2> <!-- index:2:SH:1:11:Authentication -->
    <p>
     E-MailRelay can perform 'client-side' authentication when connecting to remote
     SMTP servers, and 'server-side' authentication when remote clients connect to
     the E-MailRelay server.
    </p>

    <p>
     SMTP authentication is enabled with the <em>--client-auth</em> and <em>--server-auth</em>
     command-line options, followed by the name of a 'secrets' file containing
     usernames and passwords:
    </p>

      <div class="div-pre">
       <pre>emailrelay --as-server --server-auth=/etc/emailrelay-client.auth
emailrelay --as-client=example.com:smtp --client-auth=/etc/emailrelay-server.auth
</pre>
      </div><!-- div-pre -->
    <p>
     The client-side secrets file specified with <em>--client-auth</em> is used when
     E-MailRelay acts as a client to talk to a remote server. The file should
     contain at least one <em>client</em> entry.
    </p>

    <p>
     It is also possible to give the client authentication details directly by
     specifying <em>plain:<base64-user-id>:<base64-password></em> as the <em>--client-auth</em>
     value. This is not recommended because it exposes the account details
     through the process table, command-line history, etc.
    </p>

    <p>
     The server-side secrets file specified with <em>--server-auth</em> is used when a
     remote client tries to authenticate with the E-MailRelay server. The file
     should normally contain several <em>server</em> entries, one for each remote client.
    </p>

<img src="authentication.png" alt="image">


    <p>
     The same secrets file may be specified for both <em>--client-auth</em> and
     <em>--server-auth</em> options.
    </p>

    <p>
     The secrets file has a line-based format: blank lines are ignored and the hash
     character (#) is used for comments.
    </p>

    <p>
     Lines have four or five white-space delimited fields:
    </p>

    <ul>
     <li><em>client-or-server</em></li>
     <li><em>password-type</em></li>
     <li><em>userid</em></li>
     <li><em>password</em></li>
     <li><em>client-account-selector</em> (client-side, optional)</li>
    </ul>

    <p>
     The <em>client-or-server</em> field must be <em>client</em> or <em>server</em>; the <em>password-type</em>
     field should be <em>plain</em> or <em>md5</em>; the <em>userid</em> field is xtext-encoded
     user identifier; and the <em>password</em> field is the xtext-encoded plain password
     or a base64-encoded <em>HMAC-MD5</em> state from <em>emailrelay-passwd</em>. For <em>client</em>
     lines the password-type can also be <em>oauth</em>.
    </p>

    <p>
     For example:
    </p>

      <div class="div-pre">
       <pre># emailrelay secrets file
client plain bob password123
server plain alice e+3Dmc2
server plain carol my+20password
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>xtext</em> encoding scheme is defined properly in RFC-3461, but basically it
     says that non-alphanumeric characters (including space, <em>+</em>, <em>#</em> and <em>=</em>) should
     be represented in uppercase hexadecimal ASCII as <em>+XX</em>. So a space should be
     written as <em>+20</em>; <em>+</em> as <em>+2B</em>; <em>#</em> as <em>+23</em>; and <em>=</em> as <em>+3D</em>.
    </p>

    <p>
     Base64 encoding can be used instead of xtext encoding by replacing <em>plain</em> by
     <em>plain:b</em>:
    </p>

      <div class="div-pre">
       <pre># emailrelay secrets file
client plain:b Ym9i cGFzc3dvcmQxMjM= # bob
server plain:b YWxpY2U= ZT1tYzI= # alice
server plain:b Y2Fyb2w= bXkgcGFzc3dvcmQ= # carol
</pre>
      </div><!-- div-pre -->
    <p>
     Note that modern email services will expect user-ids and passwords containing
     non-ASCII characters to use UTF-8 encoding with RFC-4013 normalisation.
    </p>

    <p>
     Multiple client accounts can be defined in the secrets file by using a fifth
     field as an account selector. When an e-mail message is forwarded the
     authentication account is chosen by matching the <em>ClientAccountSelector</em> in the
     message envelope file (as set by a filter) with the account selector in the
     secrets file:
    </p>

      <div class="div-pre">
       <pre># emailrelay secrets file
client plain bob password123 # no selector, authenticate as bob
client plain alice e+3Dmc2 use_alice # selector 'use_alice'
client plain:b = = noauth # selector 'noauth', no authentication
</pre>
      </div><!-- div-pre -->
    <p>
     Authentication proceeds according to an authentication 'mechanism' that is
     advertised by the server and selected by the client. Many authentication
     mechanisms have been defined and standardised, and the simplest ones just
     exchange a username and plain-text password. E-MailRelay supports the PLAIN,
     LOGIN and CRAM-MD5 mechanisms for both client-side and server-side
     authentication as a minimum, with XOAUTH2 on for client-side authentication.
     Other mechanisms might be built in or available via PAM (see below).
    </p>

    <p>
     The PLAIN, LOGIN and CRAM-MD5 mechanisms can use plain-text passwords, stored
     in the secrets file using a password-type of <em>plain</em>. In addition, the
     CRAM-MD5 mechanism can also make use of hashed passwords generated by the
     <em>emailrelay-passwd</em> program and these are stored in the secrets file with a
     password-type of <em>md5</em>.
    </p>

    <p>
     Hashed passwords are marginally more secure because the plain-text password
     which might be used on other accounts is not easily recovered. However, hashed
     passwords can only be used for HMAC authentication mechanisms that are based on
     the same hash function.
    </p>

    <p>
     Using <em>MD5</em> hashes the example secrets file would look like this:
    </p>

      <div class="div-pre">
       <pre># emailrelay secrets file
client md5 bob 9N2IRYVXqu7SkOW1Xat+wpR9NbA2R6fb61XlmqW+46E=
server md5 alice v1HOpuLIbbvgoJjhueeoqwfvtIp2C+gMA285ke+xxow=
server md5 carol x6UJKQF9f7HfhS1M+PW4s8rXIoT+L+WoqLz+rBwSKbw=
</pre>
      </div><!-- div-pre -->
    <p>
     The XOAUTH2 mechanism can be used for client-side authentication using tokens
     that have been recently obtained from a third-party authentication server and
     added to the secrets file with a password-type of <em>oauth</em>.
    </p>

    <p>
     When the <em>--server-auth</em> option is used clients must authenticate with the
     E-MailRelay server before they can send e-mail, but it is possible to configure
     some client IP addresses as 'trusted' so that connections from these addresses
     do not have to authenticate.
    </p>

    <p>
     Trusted IP addresses are configured with lines in the secrets file having
     <em>server</em> in the first field, <em>none</em> in the second field, a wildcarded IP
     address in the third field, and an arbitrary keyword in the fourth field. The
     keyword field is passed to any external address verifier program specified by
     the <em>--address-verifier</em> command-line option; it is not used for any other
     purpose. Wildcarded IPv4 addresses can use a format like 192.168.0.0/24 or
     192.168.0.*.
    </p>

    <p>
     For example, this secrets file allows any client connecting over IPv4 from the
     192.168.0.0/24 address range, or over IPv6 from the fe80::/64 or fc00::/7
     ranges, to submit mail without requiring authentication:
    </p>

      <div class="div-pre">
       <pre># emailrelay secrets file
server none 192.168.0.* localipv4
server none fe80::/64 localipv6
server plain alice e+3Dmc2
server plain carol my+20password
</pre>
      </div><!-- div-pre -->
    <p>
     On the client side, authentication is performed when E-MailRelay connects to a
     server that implements the SMTP AUTH extension with one of the supported
     mechanisms. If client-side authentication is required but the remote server
     does not support the AUTH extension, or does not support mechanisms for which
     E-MailRelay has secrets, then forwarding will fail.
    </p>

    <p>
     When E-MailRelay successfully authenticates with the remote server the
     authentication name is passed as the AUTH parameter of the SMTP MAIL FROM
     command, ignoring any AUTH name from the original submission. This default
     policy can be modified by editing the <em>MailFromAuthOut</em> field in the message
     envelope file, perhaps by using a <em>--filter</em> or <em>--client-filter</em> program. The
     value in this envelope field should be empty for the default policy, <em><></em> for
     no AUTH name, or an xtext-encoded authentication name.
    </p>

    <p>
     The TLS layer can also be used for authentication, independently of SMTP, as
     described below.
    </p>
   <h2><a class="a-header" name="SH_1_12">TLS encryption</a></h2> <!-- index:2:SH:1:12:TLS encryption -->
    <p>
     E-MailRelay can use negotiated TLS to encrypt SMTP and POP sessions: use the
     <em>--client-tls</em> command-line option to enable client-side TLS encryption when
     E-MailRelay is acting as an SMTP client, and use <em>--server-tls</em> to enable
     server-side TLS when E-MailRelay is acting as an SMTP or POP server. The
     connections start off as unencrypted and the SMTP command <em>STARTTLS</em> (or the
     POP command <em>STLS</em>) can be used to negotiate TLS encryption before any
     passwords are exchanged.
    </p>

    <p>
     The <em>--server-tls</em> option requires that the <em>--server-tls-certificate</em> option
     is used to specify a PEM-format file containing a X.509 certificate and private
     key.
    </p>

    <p>
     This OpenSSL command can be used to create a self-signed certificate file
     suitable for testing:
    </p>

      <div class="div-pre">
       <pre>$ openssl req -x509 -noenc -subj "/CN=$USER" -newkey rsa:2048 -keyout emailrelay.pem  -out emailrelay.pem
</pre>
      </div><!-- div-pre -->
    <p>
     TLS performs encryption to prevent eavesdropping, but it does not necessarily
     do authentication to prevent man-in-the-middle attacks. For full TLS
     authentication you must use private keys and X.509 certificates symmetrically
     on both ends, with TLS verification enabled in both directions. Refer to the
     documentation of all the <em>--server-tls...</em> and <em>--client-tls...</em> command-line
     options for more details.
    </p>

    <p>
     E-MailRelay can also make outgoing SMTP connections using TLS encryption where
     the whole SMTP dialog is encrypted from the start (<em>--client-tls-connection</em>).
     This is sometimes called SMTP-over-TLS or secure SMTP (smtps) or implicit TLS
     and it is normally used with port number 465.
    </p>

    <p>
     Similarly, when using <em>--server-tls-connection</em> the E-MailRelay server will
     expect all connections to be using TLS from the start, so the whole SMTP
     dialogue is encrypted, without the need for <em>STARTTLS</em>.
    </p>
   <h2><a class="a-header" name="SH_1_13">PAM authentication</a></h2> <!-- index:2:SH:1:13:PAM authentication -->
    <p>
     E-MailRelay on Linux supports the use of PAM (Pluggable Authentication Modules)
     for authentication if it has been built with the <em>--with-pam</em> configure option.
    </p>

    <p>
     PAM authentication can be used to authenticate SMTP and POP connections coming
     in from remote clients; it cannot be used by E-MailRelay to supply passwords
     when acting as an SMTP client.
    </p>

    <p>
     Use <em>--server-auth=pam:</em> and/or <em>--pop-auth=pam:</em> on the command-line to use
     PAM authentication for SMTP and POP respectively. The E-MailRelay server will
     then advertise an SMTP authentication mechanism of PLAIN and do the actual
     authentication via PAM.
    </p>

    <p>
     The PAM system itself must be configured with a service of <em>emailrelay</em>. This
     normally involves creating a file <em>/etc/pam.d/emailrelay</em> containing something
     like the following:
    </p>

      <div class="div-pre">
       <pre>auth requisite pam_unix.so nullok_secure
</pre>
      </div><!-- div-pre -->
    <p>
     With this configuration the E-MailRelay server will use normal unix system
     account names and passwords to authenticate remote clients. On some systems
     this will require special permissioning to allow the E-MailRelay server to
     read the shadow password database, so run the server as <em>root</em> and also add the
     <em>--user=root</em> command-line option to make sure that the process's effective
     user-id stays as <em>root</em> while it accesses the PAM system.
    </p>
   <h2><a class="a-header" name="SH_1_14">Routing</a></h2> <!-- index:2:SH:1:14:Routing -->
    <p>
     E-MailRelay is often used to store-and-forward e-mail messages, with the
     forwarded messages going to a <em>smarthost</em> for onward routing. (The smarthost
     address is given by the <em>--forward-to</em> or <em>--as-client</em> command-line option.)
    </p>

    <p>
     However, E-MailRelay can also be used to route outgoing e-mail messages directly
     to their final destinations without needing a smarthost.
    </p>

    <p>
     The <em>ForwardToAddress</em> field in every message envelope file is normally empty
     but it can be populated by a filter script to activate message routing. If
     E-MailRelay sees a TCP address in the <em>ForwardToAddress</em> field when a message is
     being forwarded then it will connect to that address rather than the default
     <em>--forward-to</em> address from the command-line or configuration file. And if every
     message is given a <em>ForwardToAddress</em> then the command-line <em>--forward-to</em>
     address will not be used at all so it can be a dummy address like
     <em>127.0.0.1:9</em>.
    </p>

    <p>
     The <em>ForwardToAddress</em> should normally be an IP address and port number obtained
     from a MX DNS query but it can also be a domain name and port number, in which
     case a normal A or AAAA DNS lookup is used to determine the network address.
    </p>

    <p>
     Normal e-mail routing is done according to the domain names in the message
     recipient addresses (so a message to <em>alice@example.com</em> gets routed to
     <em>example.com:25</em>) and using MX DNS lookups. But if there are multiple recipients
     with different domain names then the message will have to be split up into
     independent copies. This means that normal e-mail routing is best done in two
     stages: first use a filter to split the message into independent copies grouped
     by domain, and then use a client filter to do MX DNS lookups on those domain
     names to populate the <em>ForwardToAddress</em>.
    </p>

    <p>
     (The built-in <em>split:</em> filter can be used to split messages by recipient domain
     and store the domain name in the <em>ForwardTo</em> envelope field.)
    </p>

    <p>
     If E-MailRelay sees a <em>ForwardTo</em> value in the envelope file when it is
     forwarding a message and if there is a defined <em>--client-filter</em> then the filter
     will be run early so that it can populate a <em>ForwardToAddress</em> before connecting
     to the remote server. The contents of the <em>ForwardTo</em> field is not interpreted
     by E-MailRelay itself; it causes the client filter to run early but then it is
     up to the filter to make use of its value.
    </p>

    <p>
     (The built-in <em>mx:</em> filter can be used to do a MX DNS lookup on the <em>ForwardTo</em>
     domain and fill in the <em>ForwardToAddress</em>.)
    </p>

    <p>
     Connection failures do not cause message forwarding to fail so any messages
     routed to unavailable addresses will stay in the spool directory. Use <em>--poll</em>
     to make sure that these messages are retried and check the spool directory for
     old messages files from time to time.
    </p>

    <p>
     If routed SMTP connections need to authenticate using different client account
     details then the filter that sets the <em>ForwardToAddress</em> in the message envelope
     file should also populate the <em>ClientAccountSelector</em> field. The selector value
     in the envelope is used to pick one of the <em>client</em> rows in the client secrets
     file having a matching fifth field.
    </p>
   <h2><a class="a-header" name="SH_1_15">Delivery</a></h2> <!-- index:2:SH:1:15:Delivery -->
    <p>
     When running in store-and-forward applications E-MailRelay does not concern
     itself with message delivery; every e-mail message ends up in the main spool
     directory without regard to the recipient addresses. However, it is quite easy
     to write a <em>delivery</em> filter that examines the recipient addresses in each
     message's envelope file and copies the message files into a separate <em>mailbox</em>
     for each recipient.
    </p>

    <p>
     A <em>mailbox</em> is normally just a sub-directory of the main spool directory with a
     name derived from the first part of the recipient address. It is traditional to
     have a catch-all mailbox called <em>postmaster</em> for unrecognised names.
    </p>

    <p>
     Deriving a suitable mailbox name from the recipient address is best done by an
     address verifier. The address verifier can check each recipient address, mapping
     it to a mailbox name which then gets written to the envelope file's <em>To-Local</em>
     list. After that the delivery filter just has to copy the message files into the
     designated mailbox.
    </p>

    <p>
     Once e-mail messages have been delivered into separate mailboxes they can be
     accessed by individual users using POP with the <em>--pop-by-name</em> option. When a
     user's e-mail user agent retrieves messages using POP it supplies a user-id for
     authentication purposes and E-MailRelay will use this user-id to select the
     appropriate mailbox from which to serve up e-mails.
    </p>

    <p>
     Delivery is normally only relevant to incoming messages being received from
     external systems, but it might also be desirable for outgoing messages that are
     addressed to local users. For these messages is makes sense for the delivery
     filter to move the message files straight into the incoming mailbox rather than
     have the message forwarded to the smarthost and then come back in again.
    </p>
   <h3><a class="a-header">deliver:</a></h3>
    <p>
     The built-in <em>deliver:</em> filter does message delivery to the mailboxes associated
     with any local recipient addresses. Once an address verifier has identified
     one or more of the recipient addresses as local and the mailbox names have been
     written into the envelope file the <em>deliver:</em> filter copies the message files
     into the mailbox sub-directories. If all the recipient addresses were local then
     the filter deletes the original message from the spool directory.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--address-verifier=account: --filter=deliver:
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>deliver:</em> filter creates mailbox directories as necessary, but if the
     mailbox directory already exists and has <em>new</em>, <em>tmp</em> and <em>cur</em> sub-directories
     within it then it is treated as a <em>maildir</em> mailbox. In this case the content
     file (only) is copied into the <em>cur</em> sub-directory. This can be useful for
     serving up messages with an IMAP server such as <em>dovecot</em>.
    </p>

    <p>
     Mailboxes are normally sub-directories of the spool directory, but the
     <em>--delivery-dir</em> command-line option can be used to provide the <em>deliver:</em>
     filter with a different base directory.
    </p>
   <h2><a class="a-header" name="SH_1_16">IP addresses</a></h2> <!-- index:2:SH:1:16:IP addresses -->
    <p>
     By default the E-MailRelay server listens for connections on the wildcard IPv4
     and IPv6 addresses, and when making outgoing connections it does not explicitly
     bind an address to the the local socket.
    </p>

    <p>
     If a single network address is specified with the <em>--interface</em> command-line
     option then that address is used for listening.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface 127.0.0.1
</pre>
      </div><!-- div-pre -->
    <p>
     If the <em>--client-interface</em> option is used then that address is used to bind
     the local end of outgoing SMTP client connections.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--client-interface 192.168.0.1
</pre>
      </div><!-- div-pre -->
    <p>
     More than one address can be given in the <em>--interface</em> option separated by
     commas, or multiple <em>--interface</em> options can be used. All of those addresses
     will be used for listening.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface 192.168.0.1,127.0.0.1,fc00::1,::1
--interface 192.168.0.1 --interface 127.0.0.1 --interface fc00::1 --interface ::1
</pre>
      </div><!-- div-pre -->
    <p>
     On some systems interface names can be used, in which case all the addresses
     associated with that interface are used for listening.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface eth0
</pre>
      </div><!-- div-pre -->
    <p>
     The interface name can have a <em>-ipv4</em> or <em>-ipv6</em> suffix to limit the listening
     addresses to one address family.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface eth0-ipv4
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>--interface</em> option can also have one of the prefixes <em>smtp=</em>, <em>pop=</em> or
     <em>admin=</em> so that it is only used in that context.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface smtp=192.168.0.1 --interface pop=127.0.0.1 --interface admin=127.0.0.1
--interface smtp=eth0-ipv4,pop=eth1-ipv6
</pre>
      </div><!-- div-pre -->
    <p>
     The IPv4 and IPv6 wildcard addresses (<em>0.0.0.0</em> and <em>::</em>) can be used with
     <em>--interface</em> and <em>--client-interface</em> to enable the use of IPv4 only or IPv6
     only.
    </p>

    <p>
     To use IPv4 only for incoming connections use <em>--interface 0.0.0.0</em>; for IPv6
     only on incoming connections use <em>--interface ::</em>.
    </p>

      <div class="div-pre">
       <pre>--interface 0.0.0.0 # IPv4 only
--interface ::      # IPv6 only
</pre>
      </div><!-- div-pre -->
    <p>
     To use IPv4 only on outgoing SMTP connection use <em>--client-interface 0.0.0.0</em>;
     for IPv6 only on outgoing SMTP connections use <em>--client-interface ::</em>.
    </p>

      <div class="div-pre">
       <pre>--client-interface 0.0.0.0 # IPv4 only
--client-interface ::      # IPv6 only
</pre>
      </div><!-- div-pre -->
    <p>
     Hostnames given in the <em>--forward-to</em>, <em>--as-proxy</em> and <em>--as-client</em> options
     are resolved to IPv4 addresses and/or IPv6 addresses using DNS. If both IPv4
     and IPv6 records are returned from the DNS query then the <em>--client-interface</em>
     option can be used to select either the IPv4 or IPv6 results. Otherwise the
     first address is used, whether that is IPv4 or IPv6.
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--as-client ipv4or6.example.com:25 --client-interface 0.0.0.0
--as-client ipv4or6.example.com:25 --client-interface ::</pre>
      </div><!-- div-pre -->
   <h2><a class="a-header" name="SH_1_17">Socket activation</a></h2> <!-- index:2:SH:1:17:Socket activation -->
    <p>
     On Linux/Unix systems E-MailRelay can be passed open listening file descriptors
     at start-up by using the <em>--interface</em> option with a value like fd#3. This
     allows a service management system to do the initial listening and only start up
     the E-MailRelay server when a connection comes in. Systemd calls this "socket
     activation".
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface=fd#4
--interface=smtp=fd#5,pop=fd#6</pre>
      </div><!-- div-pre -->
   <h2><a class="a-header" name="SH_1_18">Unix domain sockets</a></h2> <!-- index:2:SH:1:18:Unix domain sockets -->
    <p>
     E-MailRelay on Linux/Unix will listen on unix-domain sockets instead of IPv4 or
     IPv6 if the <em>--interface</em> option is given with an absolute file-system path:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface=/run/smtp.s --port=0
</pre>
      </div><!-- div-pre -->
    <p>
     When listening on more than one unix-domain socket use the extended form of the
     <em>--interface</em> option with a prefix of <em>smtp=</em>, <em>pop=</em>, or <em>admin=</em>:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--interface=smtp=/run/smtp.s --port=0 --interface=pop=/run/pop.s --pop --pop-port=0
</pre>
      </div><!-- div-pre -->
    <p>
     The forwarding address can also be a unix-domain address:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--forward-to=/run/smtp.s
</pre>
      </div><!-- div-pre -->
    <p>
     And it is also possible to communicate with message filters over a unix-domain
     socket:
    </p>

    <p>
     Eg:
    </p>
      <div class="div-pre">
       <pre>--filter=net:/run/filter.s
--filter=spam:/run/spamd.s
--filter=spam-edit:/run/spamd.s</pre>
      </div><!-- div-pre -->
   <h2><a class="a-header" name="SH_1_19">SOCKS</a></h2> <!-- index:2:SH:1:19:SOCKS -->
    <p>
     E-MailRelay can use a SOCKS 4a proxy for establishing outgoing SMTP connections;
     just append the SOCKS proxy address to the SMTP server's address, separated by
     <em>@</em>.
    </p>

    <p>
     For example, this could be used to send e-mails via the Tor network, assuming
     there is a local Tor node running on port 9050:
    </p>

      <div class="div-pre">
       <pre>emailrelay --forward-to example.com:smtp@localhost:9050 ...
</pre>
      </div><!-- div-pre -->
    <p>
     The Tor system will then be used to resolve the <em>example.com</em> domain name and
     establish the connection. The target SMTP server will see a connection coming
     from the Tor exit node rather than from the E-MailRelay server.
    </p>
   <h2><a class="a-header" name="SH_1_20">SMTP extensions</a></h2> <!-- index:2:SH:1:20:SMTP extensions -->
    <p>
     Some standard extensions of the SMTP protocol can be enabled by using the
     <em>--server-smtp-config</em> and <em>--client-smtp-config</em> command-line options.
     These include the CHUNKING and SMTPUTF8 extensions defined in RFC-3030 and
     RFC-6531 respectively. However, these extensions should only be enabled if the
     next-hop SMTP server that you are forwarding to also supports them, otherwise
     there is a risk that any mail messages that require those extensions will fail
     to be forwarded.
    </p>
   <h2><a class="a-header" name="SH_1_21">Administration interface</a></h2> <!-- index:2:SH:1:21:Administration interface -->
    <p>
     If enabled with the <em>--admin</em> command-line option, the E-MailRelay server will
     provide a network interface for performing administration tasks. This is a
     simple command-line interface which is compatible with <em>netcat</em> and <em>telnet</em>:
    </p>

      <div class="div-pre">
       <pre>$ emailrelay --as-server --port=125 --forward-to=localhost:25 --admin=10026
$ telnet localhost 10026
E-MailRelay&gt; help
E-MailRelay&gt; quit
</pre>
      </div><!-- div-pre -->
    <p>
     The <em>forward</em> command is used to trigger the E-MailRelay server into forwarding
     spooled mail to the next SMTP server.
    </p>

    <p>
     The <em>flush</em> command is similar but it uses its own connection to the SMTP
     server and waits for the messages to be sent.
    </p>

    <p>
     The <em>unfail-all</em> command can be used to remove the <em>.bad</em> filename extension
     from files in the spool directory.
    </p>

    <p>
     The <em>list</em> command lists the messages in the spool directory, <em>status</em> provides
     network status information and activity statistics, and <em>notify</em> enables
     asynchronous event notification.
    </p>
   <h2><a class="a-header" name="SH_1_22">Connection blocking</a></h2> <!-- index:2:SH:1:22:Connection blocking -->
    <p>
     All incoming connections from remote network addresses are blocked by default,
     but can be allowed by using the <em>--remote-clients</em> or <em>-r</em> option. This is to
     guard against accidental exposure to the internet.
    </p>

    <p>
     Incoming SMTP connections can also be checked against DNSBL blocklists in order
     to block connections from known spammers. Use the <em>--dnsbl</em> option to define a
     list of DNSBL servers, together with a rejection threshold. If the threshold
     number of servers 'deny' the incoming connection's network address then
     E-MailRelay will drop the connection immediately.
    </p>

    <p>
     The <em>--dnsbl</em> configuration is a comma-separated list starting with a list of
     DNSBL servers, optionally followed by the threshold, millisecond timeout and DNS
     server transport address:
    </p>

      <div class="div-pre">
       <pre>emailrelay -r --dnsbl spam.example.com,block.example.com,1,500,1.1.1.1:53 ...
</pre>
      </div><!-- div-pre -->
    <p>
     The threshold defaults to 1, the timeout defaults to a small number of seconds,
     and the DNS server defaults to the first of the local system's configured
     nameservers, so a simple list of DNSBL servers can be used:
    </p>

      <div class="div-pre">
       <pre>emailrelay -r --dnsbl spam.example.com,block.example.com ...
</pre>
      </div><!-- div-pre -->
    <p>
     For backwards compatibility the comma-separated fields can be reversed:
    </p>

      <div class="div-pre">
       <pre>emailrelay -r --dnsbl 1.1.1.1:53,500,1,spam.example.com,block.example.com
</pre>
      </div><!-- div-pre -->
    <p>
     A threshold of zero means that the DNSBL servers are consulted but connections
     are always allowed. This can be combined with verbose logging (<em>--log -v</em>) for
     initial testing:
    </p>

      <div class="div-pre">
       <pre>emailrelay --log -v -r --dnsbl spam.example.com,block.example.com,0 ...
</pre>
      </div><!-- div-pre -->
    <p>
     If the timeout period expires before a collective decision is reached then the
     connection is allowed by default. This default behaviour can be changed by using
     a negative timeout, so then unresponsive DNSBL servers might result in all
     incoming connections being blocked:
    </p>

      <div class="div-pre">
       <pre>emailrelay -r --dnsbl spam.example.com,block.example.com,1,-5000 ...
</pre>
      </div><!-- div-pre -->
    <p>
     Connections from loopback and private (RFC-1918) network addresses are never
     checked.
    </p>
   <h2><a class="a-header" name="SH_1_23">POP server</a></h2> <!-- index:2:SH:1:23:POP server -->
    <p>
     The POP protocol is designed to allow e-mail user agents to retrieve and delete
     e-mail messages that have arrived at their final destination.
    </p>

    <p>
     The POP server in E-MailRelay is enabled with <em>--pop</em> and then <em>--pop-auth</em> to
     point to the authentication secrets file. By default it serves up e-mail
     messages that are in the main spool directory. However, having a POP client
     delete messages in the E-MailRelay spool directory that would otherwise be
     forwarded by SMTP is probably not a good idea. In this situation the
     <em>--pop-no-delete</em> option can be used to make the POP delete command appear to
     succeed but actually do nothing. This may confuse some POP clients resulting in
     message duplication, but more capable user agents keep track of the messages
     they have retrieved to avoid duplication.
    </p>

    <p>
     Another approach is to copy message files out of the main spool directory before
     serving them up with POP, then the POP client can safely delete them without
     affecting SMTP forwarding. The <em>--pop-by-name</em> option should be used to do this.
     E-MailRelay will then serve up e-mail messages from a sub-directory of the main
     spool directory, with the sub-directory name being just the name that the POP
     client uses to authenticate.
    </p>

    <p>
     To get the e-mail message files into the <em>--pop-by-name</em> sub-directory a filter
     script can be used. This should just copy the new envelope file and content file
     into those sub-directories of the main spool directory for which there are
     matching entries in the POP secrets file.
    </p>

    <p>
     To save disk space the POP server using <em>--pop-by-name</em> will look for content
     files in the main spool directory if it cannot see the content file in the
     sub-directory. In that case the POP delete command will delete the envelope
     file from the sub-directory but only delete the content file if there are no
     other envelope files with the same name in either the main spool directory or
     any other sub-directory.
    </p>

    <p>
     Alternatively on Linux/Unix the filter script can copy content files using
     hard links in order to save disk space.
    </p>

    <p>
     The built-in <em>copy:</em> filter can be used to support <em>--pop-by-name</em>. It copies
     message files into all sub-directories (whether they have a matching POP account
     or not) and by default it then deletes the original message files. To keep the
     original files in the main spool directory so they can be forwarded use
     <em>copy:nodelete</em>; to copy just the envelope file and leave the content file alone
     use <em>copy:pop</em>; and to copy content files with hard links use <em>copy:hardlink</em>.
     Remember to create matching sub-directories when adding users to the POP secrets
     file.
    </p>

    <p>
     The built-in <em>delivery:</em> filter also works well with <em>--pop-by-name</em>. It copies
     message files into sub-directories (now conceptually delivery mailboxes)
     according to who the message is addressed to. This requires an address verifier
     to interpret message recipient addresses as belonging to local users or not. See
     <em>Delivery</em> above for more information.
    </p>
   <h2><a class="a-header" name="SH_1_24">Run-time environment</a></h2> <!-- index:2:SH:1:24:Run-time environment -->
    <p>
     On Linux/Unix systems an E-MailRelay server started as <em>root</em> runs mostly with an
     unprivileged effective user-id and group-id given by the <em>--user</em> command-line
     option, defaulting to <em>daemon</em>. It switches back to <em>root</em> only when necessary
     to access files, bind sockets etc. although when writing spool files only the
     effective user-id is changed, not the group-id, so new files have group
     ownership corresponding unprivileged user, even without the group sticky bit on
     the directory.
    </p>

    <p>
     The program runs for most of the time with a <em>umask</em> of 077, switching to 007
     when creating files in the spool directory. After a normal installation the
     spool directory has ownership of <em>root.daemon</em> with permissions of <em>-rwxrwsr-x</em>
     so messages files are created with permissions of <em>-rw-rw----</em>. This allows
     normal users to list messages files but not read them.
    </p>

    <p>
     The <em>emailrelay-submit</em> program normally has group ownership of <em>daemon</em> with
     its group set-user-id flag set. This allows it to create message files in the
     spool directory and the files created end up owned by the submitter but with
     group ownership of <em>daemon</em>.
    </p>

    <p>
     External filters and address verifiers are executed as the unprivileged user and
     they are given an almost empty set of environment variables (<em>PATH</em> and <em>IFS</em>),
     and no open file descriptors other than <em>stdin</em> and <em>stderr</em> open onto
     <em>/dev/null</em>, and <em>stdout</em> open onto a pipe. The execve() system call is used so
     the security complications of system() or popen() are avoided.
    </p>

    <p>
     The effective user-id and group-id switching can be disabled by using
     <em>--user=root</em>.
    </p>

    <p>
     On Windows all files are opened with the _SH_DENYNO option so they can be
     accessed without sharing violations.
    </p>
   <h2><a class="a-header" name="SH_1_25">Files and directories</a></h2> <!-- index:2:SH:1:25:Files and directories -->
    <p>
     On Linux/Unix systems E-MailRelay installs by default under <em>/usr/local</em>, but
     binary distributions will probably have been built to install elsewhere.
    </p>

    <p>
     Installation directories can be defined at build-time by the following
     <em>configure</em> script command-line options:
    </p>
    <ul>
     <li>--mandir=&lt;dir&gt;</li>
     <li>--sbindir=&lt;dir&gt;</li>
     <li>--localedir=&lt;dir&gt;</li>
     <li>e_bsdinitdir=&lt;dir&gt;</li>
     <li>e_docdir=&lt;dir&gt;</li>
     <li>e_examplesdir=&lt;dir&gt;</li>
     <li>e_icondir=&lt;dir&gt;</li>
     <li>e_trdir=&lt;dir&gt;</li>
     <li>e_initdir=&lt;dir&gt;</li>
     <li>e_libdir=&lt;dir&gt;</li>
     <li>e_pamdir=&lt;dir&gt;</li>
     <li>e_spooldir=&lt;dir&gt;</li>
     <li>e_sysconfdir=&lt;dir&gt;</li>
     <li>e_rundir=&lt;dir&gt;</li>
     <li>e_systemddir=&lt;dir&gt;</li>
    </ul>

    <p>
     These are all defaulted to paths that are ultimately based on <em>--prefix</em>, so
     <em>./configure --prefix=$HOME</em> will work as expected.
    </p>

    <p>
     For a directory structure conforming more closely to the Linux File Hierarchy
     Standard (FHS) use the <em>configure.sh</em> wrapper script:
    </p>

      <div class="div-pre">
       <pre>./configure.sh
make
sudo make install
</pre>
      </div><!-- div-pre -->
    <p>
     It is possible to change the installation root directory after building by
     using <em>make DESTDIR=<root> install</em> or <em>DESTDIR=<root> make -e install</em>.
     However, this will not change the default spool directory path built into the
     scripts and executables so the correct spool directory will then have to be
     specified at run-time with the <em>--spool-dir</em> command-line option.
    </p>

    <p>
     On Windows the installation GUI prompts for two installation directories,
     and these default to <em>%ProgramFiles%/E-MailRelay</em> for programs and
     <em>%ProgramData%/E-MailRelay</em> for data.
    </p>



    <div class="div-footer">
     <p>
      Copyright (C) 2001-2023 Graeme Walker
     </p>
    </div><!-- div-footer -->
 </div> <!-- div-main -->
 </body>
</html>
<!-- Copyright (C) 2001-2023 Graeme Walker <graeme_walker@users.sourceforge.net>. All rights reserved. -->
