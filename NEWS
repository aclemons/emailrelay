News
====

Multiple configurations
-----------------------
In previous releases it has been possible to specifiy options on the
command-line and/or in a configuration file named on the command-line, and
then have the options from the configuration file added to those from the
command-line.

For example:

	./emailrelay --log -v /etc/emailrelay.conf

In this release more than one configuration file can be specified. The first
file is added to the options on the command-line as before, but then each
subsequent configuration file gives rise to a whole new configuration, as if
multiple emailrelays are running in parallel.

For example:

	./emailrelay --log -v /etc/emailrelay-in.conf /etc/emailrelay-out.conf

Some options, such as "--verbose" and "--no-daemon" are only relevant if they
are in the first configuration because they affect the process as a whole.
If they are used in subsequent configurations they are ignored.

Another way to get multiple configurations is to use prefixes on option names;
for example you can use "--in-spool-dir=/tmp/in" and "--out-spool-dir=/tmp/out",
and then also "--in-port=25" and "--out-port=587" etc.

The configuration prefixes ("in" and "out" in this example) are identified
from the "--spool-dir" options.

When using this approach configuration files are not allowed.

More built-in filters and address verifiers
-------------------------------------------
E-MailRelay allows filters that are not simple scripts by using command-line
options like "--filter=exit:99" and "--filter=spam:localhost:783", with a
small number of special prefixes that include "exit:", "net:", "file:" and
"spam:".

In this release there is a new built-in "deliver:" filter (see below), and
similarly new "allow:" and "local:" address verifiers.

A compile-time option can be used to enable any additional optional filters
and address verifiers, as follows:

	./configure.sh --enable-extra-filters --enable-extra-verifiers

The "allow:" address verifier checks that the recipient address has a username
that exists in the password database and a domain that matches the configured
"--domain". If it does not match then the address is rejected and an SMTP error
is returned to the submitting client.

The "local:" address verifier checks the recipient address against the password
database and the configured "--domain" in the same way. If the address matches
then it is treated as a local address (see below), and if it does not match
then it is accepted as a remote address with no SMTP error.

Delivery
--------
E-MailRelay does normally concern itself with the process of mail delivery; that
is, copying mail messages into an individual user's mailbox from where they can
read and ulitmatelty delete it. However, if a mail message has local recipients,
as determined by an address verifier, then the envelope and content files are
copied to files with a ".local" filename extension so that some external system
can perform message delivery.

This release adds more built-in support for message delivery by providing an
option to distribute a ".local" message into a separate mailbox sub-directory
for each message recipient. The new "--local-delivery-dir" command-line option
enables this functionality and specifies the base directory for the mailboxes.

There is also a new built-in filter that can do message delivery
("--filter=deliver:"). It assumes all message recipients are local users, so
there is no need to use an address verifier, but to avoid creating too many
mailboxes the recipient address is strictly validated against the password
database. Any message recipient that is not valid results in delivery to a
default "postmaster" mailbox.

7BIT/8BITMIME
-------------
Previous versions of E-MailRelay test message content when a message is received
and populate the "Content" field of the envelope file as either "7bit" or
"8bit". However, the SMTP client code has always largely ignored this field and
it will attempt to forward 8-bit messages to a remote server that does not
advertise 8BITMIME, albeit with a warning in the log.

In this release E-MailRelay no longer tests messages for eight-bit content,
so the envelope "Content" field will always be "8bit". If this is not desired
behaviour then a filter script should be used to test for seven-bit or eight-bit
content and edit the "Content" value in the envelope file accordingly.

The SMTP client can now be made to behave more strictly by using the new
"--client-smtp-config" command-line option so that it no longer tries to forward
eight-bit messages to seven-bit servers; eight-bit messages are failed
immediately by marking the envelope as ".bad". Using this option will need a
filter script to identify seven-bit messages otherwise all messages forwarded
to a seven-bit server will fail.

PIPELINING
----------
This release adds support for the PIPELINING SMTP extension.

Previous releases allow pipelining of the SMTP QUIT command but otherwise
require SMTP requests and responses in turn. In this release the SMTP server
code allows all SMTP commands to be pipelined, whether or not the PIPELINING
extension is advertised. The PIPELINING advertisement can be disabled with the
new "--server-smtp-config" command-line option.

The response batching behaviour described by RFC-2920 is not implemented.

The SMTP client code uses pipelining only for MAIL-FROM and RCPT-TO SMTP
commands when talking to a remote server that supports the PIPELINING extension.
This can be disabled using the "--client-smtp-config" command-line option so
then each MAIL-FROM or RCPT-TO request waits for a response before continuing.

CHUNKING/BINARYMIME and SMTPUTF8
--------------------------------
This release adds support for the CHUNKING+BINARYMIME and SMTPUTF8 extensions
to SMTP, although they are disabled by default.

It is important to note that if CHUNKING+BINARYMIME or SMTPUTF8 support is
enabled in the E-MailRelay server then the destination next-hop server must
also support these extensions. If the remote server does not support these
extensions then messages may fail immediately when they are forwarded.

In principle filter scripts can be used to convert BINARYMIME and SMTPUTF8
messages to non-BINARYMIME and non-SMTPUTF8 forms (RFC-3030 calls these
"gateway transformations"), but it might be easier to leave these extensions
disabled in the E-MailRelay server if there is any doubt about the capabilities
of the next-hop server.

Furthermore, if the the SMTPUTF8 extension is enabled in the E-MailRelay server
then the mailbox addresses passed to any address-verifier script might contain
UTF-8 characters. This might in turn require changes to the script if it assumes
that mailbox addresses are printable ASCII.

In passing, note that mailbox addresses passed to address-verifier scripts are
as they appear on the wire, so a badly-behaved SMTP client might send addresses
containing double-quotes and backslash escapes that are semantically redundant.
For example, a message submitted to "\A\l\i\c\e"@example.com will have that
address passed to the verifier with all the redundant double quotes and
backslashes present. Removing quotes and backslashes is reasonably easy for a
verifier to do, but with SMTPUTF8 things become more complex due to the way
Unicode can represent the same string in more than one way.

Another corner case with SMTPUTF8 is that the remote client might use the VRFY
SMTP command without the optional SMTPUTF8 parameter. In principle the address
verifier script should not then return UTF-8 results, but in practice it has
no way of knowning whether the SMTPUTF8 parameter was used or not. However, this
issue only arises when a verifier script determines that an address is a local
mailbox because for remote addresses the returned address strings are
effectively ignored by E-MailRelay. The issue does not arise at all when the
verifier is called as the result of a RCPT-TO command because although the
results are stored in the envelope file they are not passed back to the remote
client. If necessary the VRFY command can be disabled by using "--anonymous".

Hashed passwords
----------------
Hashed passwords using the SHA-1 or SHA-256 hashing algorithm will no longer
work when E-MailRelay is built using the latest versions of the OpenSSL and
MbedTLS libraries. Both libraries have stopped exposing the relevant state
variables used within their hashing functions. MD5 hashed passwords will still
work.

Code size
---------
The source code now contains a lot of conditional compilation directives like
"#ifndef G_LIB_SMALL" that reduce the size of the built binaries.

The Windows build and the build of the GUI on Linux are not affected because
they are built without the "G_LIB_SMALL" switch.

These extra directives make the code rather ugly so they can be removed if
necessary by running:

	libexec/reduce.sh --undo

